<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Trap Tracker ‚Äî Aamr Benbrahim</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --muted:#9aa3b2; --text:#eef2ff; --border:#232735;
      --green:#22c55e; --red:#ef4444; --orange:#f97316; --yellow:#eab308;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#090a0f,#0b0c10); color:var(--text)}
    .wrap{max-width:1020px;margin:0 auto;padding:14px}
    h1{margin:6px 0 2px;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 12px}
    .grid{display:grid;gap:12px}
    @media(min-width:960px){ .grid{grid-template-columns: 1.25fr .95fr} }

    .card{background:rgba(18,20,26,.92);border:1px solid var(--border);border-radius:18px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input, textarea, select{
      width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--border);
      background:#0f1118; color:var(--text); outline:none;
    }
    textarea{min-height:74px; resize:vertical}

    .btn{
      border:1px solid var(--border); background:#0f1118; color:var(--text);
      padding:10px 12px; border-radius:16px; font-weight:800;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{background:#1b2030;border-color:#2a3150}
    .btn.danger{background:#2a1212;border-color:#4b1f1f}

    /* BIG tap buttons */
    .tapGrid{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .tap{
      padding:18px 14px; border-radius:18px; border:1px solid var(--border);
      font-size:18px; font-weight:950; letter-spacing:.2px;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      min-height:64px;
    }
    .tap small{display:block; font-size:12px; font-weight:800; opacity:.85; margin-top:4px}
    .tap.hit{background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.35)}
    .tap.left{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.28)}
    .tap.center{background:rgba(249,115,22,.12); border-color:rgba(249,115,22,.30)}
    .tap.right{background:rgba(234,179,8,.12); border-color:rgba(234,179,8,.30)}

    .statgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .stat{border:1px solid var(--border);border-radius:16px;padding:10px;background:#0f1118}
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:950;margin-top:3px}
    .stat .s{font-size:11px;color:var(--muted);margin-top:3px}

    .pill{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:999px}

    /* 25-shot grid */
    .shotsWrap{margin-top:10px}
    .shotGrid{
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
    }
    .shot{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 8px;
      background:#0f1118;
      text-align:center;
      font-weight:950;
      min-height:48px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }
    .shot .meta{font-size:10px;font-weight:800;color:var(--muted);margin-top:3px}
    .shot.hit{background:rgba(34,197,94,.10); border-color:rgba(34,197,94,.30); color:var(--green)}
    .shot.l{background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.26); color:var(--red)}
    .shot.c{background:rgba(249,115,22,.10); border-color:rgba(249,115,22,.26); color:var(--orange)}
    .shot.r{background:rgba(234,179,8,.12); border-color:rgba(234,179,8,.26); color:var(--yellow)}
    .shot.pending{opacity:.55}

    .divider{height:1px;background:var(--border);margin:12px 0}
    .small{font-size:12px;color:var(--muted)}
    .list{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){ .list{grid-template-columns:1fr 1fr} }

    .round{border:1px solid var(--border);border-radius:18px;overflow:hidden;background:#0f1118}
    .roundHead{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px}
    .meta2{font-size:12px;color:var(--muted)}
    .mini{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px}
    .box{border:1px solid var(--border);border-radius:16px;padding:10px}
    .box .k{font-size:11px;color:var(--muted)}
    .box .v{font-size:18px;font-weight:950;margin-top:4px}
    .g{background:rgba(34,197,94,.08)} .rr{background:rgba(239,68,68,.08)}
    .oo{background:rgba(249,115,22,.08)} .yy{background:rgba(234,179,8,.08)}
    .notes{padding:12px;color:#d7def0;font-size:13px;white-space:pre-wrap}

    .filters{display:grid;gap:10px}
    @media(min-width:720px){ .filters{grid-template-columns: 1.2fr 1fr 1fr 1fr} }
    .hint{font-size:11px;color:var(--muted)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border); border-radius:999px; padding:6px 10px;
      background:#0f1118; font-size:12px; font-weight:900;
    }
    .badge strong{font-weight:950}
    .badge.left{border-color:rgba(239,68,68,.35)}
    .badge.center{border-color:rgba(249,115,22,.35)}
    .badge.right{border-color:rgba(234,179,8,.35)}

    /* Best/Worst pills */
    .pillScore{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#0f1118;font-size:12px;font-weight:950;
      margin-right:6px;
      white-space:nowrap;
    }
    .pillScore.good{border-color:rgba(34,197,94,.35); color:var(--green)}
    .pillScore.mid{border-color:rgba(249,115,22,.35); color:var(--orange)}
    .pillScore.low{border-color:rgba(239,68,68,.35); color:var(--red)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Trap Tracker ‚Äî Aamr Benbrahim</h1>
    <p class="sub">One tap per target. 25 shots = 5 stations √ó 5 targets. Colors: Hit=green, Left=red, Center=orange, Right=yellow.</p>

    <div class="grid">
      <!-- LIVE ROUND -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:950;font-size:16px">Live Round Mode</div>
            <div class="small" id="statusLine">Ready.</div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn" id="undoBtn">‚Ü©Ô∏é Undo</button>
            <button class="btn danger" id="resetRoundBtn">Reset round</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="statgrid">
          <div class="stat"><div class="k">Station</div><div class="v" id="stationV">1/5</div></div>
          <div class="stat"><div class="k">Shot</div><div class="v" id="shotV">0/25</div></div>
          <div class="stat"><div class="k">Score</div><div class="v" id="scoreV">0/25</div></div>
          <div class="stat"><div class="k">Hit %</div><div class="v" id="hitPctV">0%</div></div>
        </div>

        <div class="divider"></div>

        <div class="tapGrid">
          <button class="btn tap hit" id="tapHit">‚úÖ HIT<small>Green</small></button>
          <button class="btn tap left" id="tapLeft">‚ùå MISS LEFT<small>Red</small></button>
          <button class="btn tap center" id="tapCenter">‚ùå MISS CENTER<small>Orange</small></button>
          <button class="btn tap right" id="tapRight">‚ùå MISS RIGHT<small>Yellow</small></button>
        </div>

        <div class="shotsWrap">
          <div class="row" style="justify-content:space-between; margin-top:12px">
            <div class="row" style="gap:10px">
              <div class="pill"><span class="dot" style="background:var(--green)"></span>Hit</div>
              <div class="pill"><span class="dot" style="background:var(--red)"></span>Left</div>
              <div class="pill"><span class="dot" style="background:var(--orange)"></span>Center</div>
              <div class="pill"><span class="dot" style="background:var(--yellow)"></span>Right</div>
            </div>
            <div class="small">Tap buttons above, grid fills automatically.</div>
          </div>

          <div class="shotGrid" id="shotGrid" style="margin-top:10px"></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div style="flex:1;min-width:160px">
            <label>Date</label>
            <input id="date" type="date" />
          </div>
          <div style="flex:1;min-width:160px">
            <label>Club (optional)</label>
            <input id="club" placeholder="e.g. Rabat Shooting Club" />
          </div>
          <div style="flex:1;min-width:160px">
            <label>Field (optional)</label>
            <input id="field" placeholder="e.g. Field 2" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1;min-width:160px">
            <label>Notes (optional)</label>
            <textarea id="notes" placeholder="Wind, light, ammo, focus cue, what felt off..."></textarea>
          </div>
        </div>

        <div class="row" style="justify-content:space-between; margin-top:8px">
          <div class="small">When you reach 25/25, you can save the round.</div>
          <button class="btn primary" id="saveRoundBtn">Save round</button>
        </div>
      </div>

      <!-- OVERVIEW -->
      <div class="card">
        <div style="font-weight:950;font-size:16px">Overview</div>
        <div class="small" id="overviewSubtitle">Simple stats for the selected period</div>

        <div class="divider"></div>

        <div class="filters">
          <div>
            <label>Time range</label>
            <select id="rangeSel">
              <option value="today">Today</option>
              <option value="week">This week</option>
              <option value="month">This month</option>
              <option value="last3">Last 3 months</option>
              <option value="last6">Last 6 months</option>
              <option value="year">This year</option>
              <option value="all">All time</option>
              <option value="monthPick">Past month‚Ä¶</option>
            </select>
            <div class="hint">Pick ‚ÄúPast month‚Ä¶‚Äù to choose any month.</div>
          </div>

          <div>
            <label>Past months</label>
            <select id="monthSel" disabled>
              <option value="">Select month‚Ä¶</option>
            </select>
            <div class="hint">Only active when ‚ÄúPast month‚Ä¶‚Äù is selected.</div>
          </div>

          <div>
            <label>Club (optional)</label>
            <select id="clubSel">
              <option value="all">All clubs</option>
            </select>
          </div>

          <div>
            <label>Field (optional)</label>
            <select id="fieldSel">
              <option value="all">All fields</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between; gap:10px">
          <div class="row" style="gap:10px; flex-wrap:wrap">
            <span class="badge" id="mostMissedBadge" style="display:none"></span>
            <span class="badge" id="insightBadge" style="display:none"></span>
          </div>
          <div class="small" id="rangeCount">0 rounds</div>
        </div>

        <div style="height:10px"></div>

        <!-- Top 3 stats -->
        <div class="statgrid" style="grid-template-columns:repeat(3,minmax(0,1fr))">
          <div class="stat">
            <div class="k">Average</div>
            <div class="v" id="avgHits">0.0/25</div>
            <div class="s" id="avgHitsSub">Avg hit %: 0%</div>
          </div>

          <div class="stat">
            <div class="k">Best / Worst</div>
            <div class="v" id="bestWorst">‚Äî</div>
            <div class="s" id="bestWorstSub">Colors: ‚â•20 green ‚Ä¢ 18‚Äì19 orange ‚Ä¢ <18 red</div>
          </div>

          <div class="stat">
            <div class="k">Last 10 rounds</div>
            <div class="v" id="last10">‚Äî</div>
            <div class="s" id="last10Sub">Avg hits (if ‚â•10)</div>
          </div>
        </div>

        <!-- Miss diagram -->
        <div class="divider"></div>

        <div class="stat" style="background:#0f1118">
          <div class="k">Average misses per round</div>

          <div class="row" style="justify-content:space-between; align-items:flex-start; gap:12px; margin-top:6px">
            <div style="flex:1;text-align:center">
              <div style="font-weight:950;color:var(--red);font-size:18px" id="avgML">0.0</div>
              <div class="small">LEFT</div>
            </div>

            <div style="flex:1;text-align:center">
              <div style="font-weight:950;color:var(--orange);font-size:18px" id="avgMC">0.0</div>
              <div class="small">CENTER</div>
            </div>

            <div style="flex:1;text-align:center">
              <div style="font-weight:950;color:var(--yellow);font-size:18px" id="avgMR">0.0</div>
              <div class="small">RIGHT</div>
            </div>
          </div>

          <svg viewBox="0 0 320 90" width="100%" height="90" style="margin-top:8px">
            <path d="M160 80 C120 60, 90 40, 60 18" fill="none" stroke="var(--red)" stroke-width="6" stroke-linecap="round"/>
            <path d="M160 80 C160 58, 160 40, 160 16" fill="none" stroke="var(--orange)" stroke-width="6" stroke-linecap="round"/>
            <path d="M160 80 C200 60, 230 40, 260 18" fill="none" stroke="var(--yellow)" stroke-width="6" stroke-linecap="round"/>
            <circle cx="160" cy="80" r="7" fill="#0f1118" stroke="var(--border)" stroke-width="2"/>
          </svg>

          <div class="s" id="missDiagramSub">Based on selected period</div>
        </div>

        <div class="divider"></div>

        <div class="small">
          Goal: reduce your <b>most missed direction</b> first ‚Äî it usually gives the fastest improvement.
        </div>
      </div>
    </div>

    <!-- SAVED ROUNDS -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:950;font-size:16px">Saved Rounds</div>
          <div class="small" id="countLine">0 total</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="filters" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
        <div>
          <label>Show</label>
          <select id="savedRange">
            <option value="today">Today</option>
            <option value="day">A specific day‚Ä¶</option>
            <option value="all">All rounds</option>
          </select>
        </div>

        <div>
          <label>Date</label>
          <input id="savedDate" type="date" disabled />
        </div>

        <div>
          <label>Club</label>
          <select id="savedClub">
            <option value="all">All clubs</option>
          </select>
        </div>

        <div>
          <label>Field</label>
          <select id="savedField">
            <option value="all">All fields</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <div class="list" id="list"></div>
      <div id="empty" class="small" style="display:none;margin-top:10px">No rounds found for these filters.</div>
    </div>

    <p class="small" style="margin:14px 2px 28px">
      Next upgrades: station-by-station stats (S1..S5 patterns) + vibration feedback per shot.
    </p>
  </div>

<script>
  const KEY = "trap_tracker_live_issf_v3_aamr";
  const $ = (id) => document.getElementById(id);

  const pct = (a,b)=> b? Math.round((a/b)*1000)/10 : 0;

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  $("date").value = todayISO();
  $("savedDate").value = todayISO();

  function uid(){
    return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,9)}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"\"":'&quot;',"'":'&#39;'}[c]));
  }

  function startOfWeek(d){
    const x = new Date(d);
    const day = (x.getDay() + 6) % 7; // Monday = 0
    x.setDate(x.getDate() - day);
    x.setHours(0,0,0,0);
    return x;
  }
  function startOfMonth(d){
    const x = new Date(d.getFullYear(), d.getMonth(), 1);
    x.setHours(0,0,0,0);
    return x;
  }
  function startOfYear(d){
    const x = new Date(d.getFullYear(), 0, 1);
    x.setHours(0,0,0,0);
    return x;
  }
  function addMonths(d, n){
    const x = new Date(d);
    x.setMonth(x.getMonth() + n);
    return x;
  }
  function parseISODate(iso){
    const [y,m,dd] = (iso||"").split("-").map(Number);
    if(!y||!m||!dd) return null;
    const x = new Date(y, m-1, dd);
    x.setHours(0,0,0,0);
    return x;
  }
  function monthKey(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }
  function monthLabel(key){
    const [y,m] = key.split("-").map(Number);
    const names = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${names[m-1]} ${y}`;
  }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      const list = raw ? JSON.parse(raw) : [];
      return Array.isArray(list) ? list : [];
    }catch{ return []; }
  }
  function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

  // LIVE ROUND STATE (25 shots): 'H','L','C','R'
  let liveShots = [];
  let rounds = load();

  function countsFromShots(shots){
    let hit=0, ml=0, mc=0, mr=0;
    for(const s of shots){
      if(s==="H") hit++;
      else if(s==="L") ml++;
      else if(s==="C") mc++;
      else if(s==="R") mr++;
    }
    return {shots: 25, hit, ml, mc, mr};
  }
  function stationIndexFromShotIndex(i){
    return Math.min(4, Math.floor(i/5));
  }

  function renderLive(){
    const idx = liveShots.length;
    const station = stationIndexFromShotIndex(Math.max(0, idx)) + 1;
    const {hit} = countsFromShots(liveShots);

    $("stationV").textContent = `${Math.min(5, station)}/5`;
    $("shotV").textContent = `${idx}/25`;
    $("scoreV").textContent = `${hit}/25`;
    $("hitPctV").textContent = `${pct(hit, Math.max(1, idx))}%`;

    if(idx === 0) $("statusLine").textContent = "Ready. Tap one button per target.";
    else if(idx < 25) $("statusLine").textContent = `Live‚Ä¶ Station ${Math.min(5, station)} ‚Ä¢ Shot ${idx+1}/25`;
    else $("statusLine").textContent = "Round complete. Save it or reset.";

    const done = idx >= 25;
    $("tapHit").disabled = done;
    $("tapLeft").disabled = done;
    $("tapCenter").disabled = done;
    $("tapRight").disabled = done;
    $("undoBtn").disabled = (idx === 0);

    const grid = $("shotGrid");
    grid.innerHTML = "";
    for(let i=0;i<25;i++){
      const s = liveShots[i];
      const st = Math.floor(i/5) + 1;
      const inSt = (i % 5) + 1;
      const el = document.createElement("div");
      el.className = "shot " + (
        s==="H" ? "hit" :
        s==="L" ? "l" :
        s==="C" ? "c" :
        s==="R" ? "r" : "pending"
      );
      const label = s==="H" ? "HIT" : s==="L" ? "LEFT" : s==="C" ? "CENTER" : s==="R" ? "RIGHT" : "‚Äî";
      el.innerHTML = `<div>${label}</div><div class="meta">S${st} ‚Ä¢ #${inSt}</div>`;
      grid.appendChild(el);
    }
  }

  function pushShot(code){
    if(liveShots.length >= 25) return;
    liveShots.push(code);
    renderLive();
  }

  $("tapHit").addEventListener("click", ()=>pushShot("H"));
  $("tapLeft").addEventListener("click", ()=>pushShot("L"));
  $("tapCenter").addEventListener("click", ()=>pushShot("C"));
  $("tapRight").addEventListener("click", ()=>pushShot("R"));

  $("undoBtn").addEventListener("click", ()=>{
    liveShots.pop();
    renderLive();
  });

  $("resetRoundBtn").addEventListener("click", ()=>{
    liveShots = [];
    renderLive();
  });

  $("saveRoundBtn").addEventListener("click", ()=>{
    if(liveShots.length !== 25){
      $("statusLine").textContent = `You are at ${liveShots.length}/25. Finish the round to save.`;
      return;
    }
    const c = countsFromShots(liveShots);
    rounds.unshift({
      id: uid(),
      date: $("date").value || todayISO(),
      club: $("club").value.trim(),
      field: $("field").value.trim(),
      notes: $("notes").value,
      liveShots: liveShots.slice(),
      ...c,
      createdAt: Date.now()
    });
    save(rounds);

    liveShots = [];
    $("notes").value = "";
    renderAll();
  });

  function unique(list){
    return Array.from(new Set(list.filter(Boolean)));
  }

  function rebuildDropdowns(){
    const clubs = unique(rounds.map(r => (r.club||"").trim())).sort((a,b)=>a.localeCompare(b));
    const fields = unique(rounds.map(r => (r.field||"").trim())).sort((a,b)=>a.localeCompare(b));

    // Overview selectors
    const clubSel = $("clubSel");
    const fieldSel = $("fieldSel");
    const keepClub = clubSel.value || "all";
    const keepField = fieldSel.value || "all";

    clubSel.innerHTML = `<option value="all">All clubs</option>` + clubs.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    fieldSel.innerHTML = `<option value="all">All fields</option>` + fields.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");

    clubSel.value = clubs.includes(keepClub) ? keepClub : "all";
    fieldSel.value = fields.includes(keepField) ? keepField : "all";

    // Saved rounds selectors
    const savedClub = $("savedClub");
    const savedField = $("savedField");
    const keepSC = savedClub.value || "all";
    const keepSF = savedField.value || "all";

    savedClub.innerHTML = `<option value="all">All clubs</option>` + clubs.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    savedField.innerHTML = `<option value="all">All fields</option>` + fields.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");

    savedClub.value = clubs.includes(keepSC) ? keepSC : "all";
    savedField.value = fields.includes(keepSF) ? keepSF : "all";

    // Month dropdown
    const monthSel = $("monthSel");
    const monthKeys = unique(rounds.map(r => {
      const d = parseISODate(r.date);
      return d ? monthKey(d) : "";
    })).sort((a,b)=> (a>b ? -1 : 1)); // newest first

    const keepMonth = monthSel.value || "";
    monthSel.innerHTML = `<option value="">Select month‚Ä¶</option>` + monthKeys.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join("");
    monthSel.value = monthKeys.includes(keepMonth) ? keepMonth : "";
  }

  function filterByMeta(list, clubVal, fieldVal){
    const c = clubVal || "all";
    const f = fieldVal || "all";
    return list.filter(r => {
      const okC = (c==="all") || ((r.club||"").trim() === c);
      const okF = (f==="all") || ((r.field||"").trim() === f);
      return okC && okF;
    });
  }

  function filterByRange(list){
    const now = new Date(); now.setHours(0,0,0,0);
    const range = $("rangeSel").value;
    const monthPick = $("monthSel").value;

    let start = null, end = null; // [start, end)
    if(range === "all"){
      start = null; end = null;
    } else if(range === "today"){
      start = new Date(now);
      end = new Date(now); end.setDate(end.getDate()+1);
    } else if(range === "week"){
      start = startOfWeek(now);
      end = new Date(start); end.setDate(end.getDate()+7);
    } else if(range === "month"){
      start = startOfMonth(now);
      end = addMonths(start, 1);
    } else if(range === "last3"){
      end = addMonths(startOfMonth(now), 1);
      start = addMonths(end, -3);
    } else if(range === "last6"){
      end = addMonths(startOfMonth(now), 1);
      start = addMonths(end, -6);
    } else if(range === "year"){
      start = startOfYear(now);
      end = new Date(now.getFullYear()+1, 0, 1);
    } else if(range === "monthPick"){
      if(!monthPick) return [];
      const [y,m] = monthPick.split("-").map(Number);
      start = new Date(y, m-1, 1); start.setHours(0,0,0,0);
      end = new Date(y, m, 1); end.setHours(0,0,0,0);
    }

    return list.filter(r=>{
      const d = parseISODate(r.date);
      if(!d) return false;
      if(!start && !end) return true;
      return (d >= start && d < end);
    });
  }

  function tier(score){
    if(score >= 20) return "good";
    if(score >= 18) return "mid";
    return "low";
  }

  function renderOverview(){
    const isMonthPick = $("rangeSel").value === "monthPick";
    $("monthSel").disabled = !isMonthPick;

    let list = rounds.slice();
    list = filterByMeta(list, $("clubSel").value, $("fieldSel").value);
    list = filterByRange(list);

    $("rangeCount").textContent = `${list.length} rounds`;

    if(list.length === 0){
      $("avgHits").textContent = "0.0/25";
      $("avgHitsSub").textContent = "Avg hit %: 0%";
      $("bestWorst").textContent = "‚Äî";
      $("last10").textContent = "‚Äî";
      $("last10Sub").textContent = "Avg hits (if ‚â•10)";
      $("avgML").textContent = "0.0";
      $("avgMC").textContent = "0.0";
      $("avgMR").textContent = "0.0";
      $("missDiagramSub").textContent = "Based on selected period";
      $("mostMissedBadge").style.display = "none";
      $("insightBadge").style.display = "none";
      return;
    }

    const totalHit = list.reduce((s,r)=>s+(r.hit||0),0);
    const totalL = list.reduce((s,r)=>s+(r.ml||0),0);
    const totalC = list.reduce((s,r)=>s+(r.mc||0),0);
    const totalR = list.reduce((s,r)=>s+(r.mr||0),0);

    const avgHits = totalHit / list.length;
    const avgPct = pct(totalHit, list.length*25);

    const scores = list.map(r=> (r.hit||0));
    const best = Math.max(...scores);
    const worst = Math.min(...scores);

    const byRecent = list.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    const last10List = byRecent.slice(0,10);
    const last10Avg = last10List.length ? (last10List.reduce((s,r)=>s+(r.hit||0),0) / last10List.length) : null;

    const misses = [
      {k:"LEFT", v: totalL, cls:"left", dot:"var(--red)"},
      {k:"CENTER", v: totalC, cls:"center", dot:"var(--orange)"},
      {k:"RIGHT", v: totalR, cls:"right", dot:"var(--yellow)"},
    ].sort((a,b)=>b.v-a.v);

    const topMiss = misses[0];

    $("avgHits").textContent = `${avgHits.toFixed(1)}/25`;
    $("avgHitsSub").textContent = `Avg hit %: ${avgPct}%`;

    const bestStar = best >= 23 ? " ‚≠ê" : "";
    $("bestWorst").innerHTML = `
      <span class="pillScore ${tier(best)}">Best: ${best}/25${bestStar}</span>
      <span class="pillScore ${tier(worst)}">Worst: ${worst}/25</span>
    `;

    if(last10List.length >= 10){
      $("last10").textContent = `${last10Avg.toFixed(1)}/25`;
      $("last10Sub").textContent = `Average of last 10 rounds`;
    } else {
      $("last10").textContent = "‚Äî";
      $("last10Sub").textContent = `Need 10 rounds (you have ${last10List.length})`;
    }

    const avgML = totalL / list.length;
    const avgMC = totalC / list.length;
    const avgMR = totalR / list.length;

    $("avgML").textContent = avgML.toFixed(1);
    $("avgMC").textContent = avgMC.toFixed(1);
    $("avgMR").textContent = avgMR.toFixed(1);
    $("missDiagramSub").textContent = `Avg misses per round (selected period)`;

    const badge = $("mostMissedBadge");
    badge.className = `badge ${topMiss.cls}`;
    badge.style.display = "inline-flex";
    badge.innerHTML = `<span class="dot" style="background:${topMiss.dot}"></span> Most missed: <strong>${topMiss.k}</strong> (${topMiss.v})`;

    const insight = $("insightBadge");
    insight.style.display = "inline-flex";
    let text = "";
    if(topMiss.k === "CENTER") text = "Focus: timing + trigger discipline";
    if(topMiss.k === "LEFT") text = "Focus: line & move for LEFT targets";
    if(topMiss.k === "RIGHT") text = "Focus: keep moving through RIGHT";
    insight.className = "badge";
    insight.innerHTML = `üéØ ${text}`;

    const r = $("rangeSel").value;
    const label =
      r==="today" ? "Today" :
      r==="week" ? "This week" :
      r==="month" ? "This month" :
      r==="last3" ? "Last 3 months" :
      r==="last6" ? "Last 6 months" :
      r==="year" ? "This year" :
      r==="all" ? "All time" :
      r==="monthPick" ? ( $("monthSel").value ? monthLabel($("monthSel").value) : "Past month" ) :
      "Selected period";
    $("overviewSubtitle").textContent = `Stats for: ${label}`;
  }

  function renderSaved(){
    let list = rounds.slice();

    const mode = $("savedRange").value;
    const today = todayISO();
    if(mode === "today"){
      list = list.filter(r => (r.date||"") === today);
      $("savedDate").disabled = true;
    } else if(mode === "day"){
      $("savedDate").disabled = false;
      const d = $("savedDate").value || today;
      list = list.filter(r => (r.date||"") === d);
    } else {
      $("savedDate").disabled = true;
    }

    list = filterByMeta(list, $("savedClub").value, $("savedField").value);
    list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    $("countLine").textContent = `${rounds.length} total ‚Ä¢ ${list.length} shown`;

    const container = $("list");
    container.innerHTML = "";
    $("empty").style.display = list.length ? "none" : "block";

    for(const r of list){
      const miss = (r.ml||0)+(r.mc||0)+(r.mr||0);
      const shotsArr = Array.isArray(r.liveShots) ? r.liveShots : [];
      const preview = shotsArr.slice(0,25).map((s)=>{
        const cls = s==="H" ? "hit" : s==="L" ? "l" : s==="C" ? "c" : s==="R" ? "r" : "pending";
        const ch = s==="H" ? "‚úì" : s==="L" ? "L" : s==="C" ? "C" : s==="R" ? "R" : "¬∑";
        return `<span style="
          display:inline-flex;align-items:center;justify-content:center;
          width:22px;height:22px;border-radius:8px;border:1px solid var(--border);
          margin:2px;font-weight:950;font-size:12px;
          ${cls==='hit'?'background:rgba(34,197,94,.10);color:var(--green);border-color:rgba(34,197,94,.28)':''}
          ${cls==='l'?'background:rgba(239,68,68,.10);color:var(--red);border-color:rgba(239,68,68,.25)':''}
          ${cls==='c'?'background:rgba(249,115,22,.10);color:var(--orange);border-color:rgba(249,115,22,.25)':''}
          ${cls==='r'?'background:rgba(234,179,8,.10);color:var(--yellow);border-color:rgba(234,179,8,.25)':''}
        ">${ch}</span>`;
      }).join("");

      const club = (r.club||"").trim();
      const field = (r.field||"").trim();
      const place = [club, field].filter(Boolean).join(" ‚Ä¢ ");

      const el = document.createElement("div");
      el.className = "round";
      el.innerHTML = `
        <div class="roundHead">
          <div>
            <div style="font-weight:950">${r.date || ""} <span class="meta2">${place ? "‚Ä¢ "+escapeHtml(place) : ""}</span></div>
            <div class="meta2">Score: <b>${r.hit}/25</b> ‚Ä¢ Hit ${pct(r.hit,25)}% ‚Ä¢ Miss ${pct(miss,25)}%</div>
          </div>
          <button class="btn danger" data-del="${r.id}">Delete</button>
        </div>

        <div style="padding:10px 12px;border-bottom:1px solid var(--border)">
          <div class="small" style="margin-bottom:6px">Pattern (‚úì hit, L/C/R miss type)</div>
          <div style="display:flex;flex-wrap:wrap;gap:0">${preview || "<span class='small'>No pattern saved.</span>"}</div>
        </div>

        <div class="mini">
          <div class="box g"><div class="k">Hit</div><div class="v" style="color:var(--green)">${r.hit}</div></div>
          <div class="box rr"><div class="k">Miss Left</div><div class="v" style="color:var(--red)">${r.ml}</div></div>
          <div class="box oo"><div class="k">Miss Center</div><div class="v" style="color:var(--orange)">${r.mc}</div></div>
          <div class="box yy"><div class="k">Miss Right</div><div class="v" style="color:var(--yellow)">${r.mr}</div></div>
        </div>
        <div class="notes">${r.notes ? escapeHtml(r.notes) : "<span class='meta2'>No notes.</span>"}</div>
      `;
      container.appendChild(el);
    }

    container.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        rounds = rounds.filter(r=>r.id!==id);
        save(rounds);
        renderAll();
      });
    });
  }

  function renderAll(){
    rebuildDropdowns();
    renderLive();
    renderOverview();
    renderSaved();
  }

  // Overview controls
  $("rangeSel").addEventListener("change", renderOverview);
  $("monthSel").addEventListener("change", renderOverview);
  $("clubSel").addEventListener("change", renderOverview);
  $("fieldSel").addEventListener("change", renderOverview);

  // Saved controls
  $("savedRange").addEventListener("change", renderSaved);
  $("savedDate").addEventListener("change", renderSaved);
  $("savedClub").addEventListener("change", renderSaved);
  $("savedField").addEventListener("change", renderSaved);

  // first render
  renderAll();
</script>
</body>
</html>
