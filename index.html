<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>TrapPerformance</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TrapPerformance">
 
  <style>
    :root{
      --bg:#0a0b0e; --card:#141519; --muted:#9a9fa8; --text:#f1f3f7; --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.45);

      /* 5-zone greens (hits) */
      --g1:#22c55e;   /* center-ish main */
      --g2:#16a34a;
      --g3:#4ade80;
      --g4:#10b981;
      --g5:#86efac;

      /* 5-zone reds (misses) */
      --r1:#ef4444;
      --r2:#dc2626;
      --r3:#f87171;
      --r4:#fb7185;
      --r5:#fecaca;

      --orange:#facc15; 
      --yellow:#eab308;
      --purple:#ff7a18;     /* fluorescent clay orange */
      --purple2:#ff9f45;   /* softer orange for highlights (optional) */

      --b1:#09B6E6;
      --p1:#952DED;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#05060a,#07080c);
      color:var(--text);
    }

    .wrap{max-width:1020px;margin:0 auto;padding:14px}
    h1{margin:6px 0 2px;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 12px}
    .grid{display:grid;gap:12px}
    @media(min-width:960px){ .grid{grid-template-columns: 1.25fr .95fr} }

    .card{
      background:#111214;
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px;
      padding:12px;
      box-shadow:
        0 8px 24px rgba(0,0,0,.45);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}

    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#00070D;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:74px; resize:vertical}

    .btn{
      border: none;
      background:#00070D;
      color:var(--text);
      padding:10px 12px;
      border-radius:16px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{background:#23263a;border-color:#30323a;box-shadow: inset 0 0 0 1px rgba(120,130,255,.25)}
    .btn.danger{background:#2a1212;border-color:#4b1f1f}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .divider{height:1px;background:var(--border);margin:12px 0}
    .small{font-size:12px;color:var(--muted)}
    .hint{font-size:11px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:999px}

    .statgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .stat{border:2px solid var(--border);border-radius:16px;padding:10px;background:#000D0D}
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:950;margin-top:3px}
    .stat .s{font-size:11px;color:var(--muted);margin-top:3px}

    /* 25-shot grid */
    .shotsWrap{margin-top:10px}
    .shotGrid{
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
    }
    .shot{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 8px;
      background:#0f1118;
      text-align:center;
      font-weight:950;
      min-height:52px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      line-height:1.05;
    }
    .shot .meta{font-size:10px;font-weight:800;color:var(--muted);margin-top:4px}

    .shot.pending{opacity:.55}

    /* Outcome styling (filled lightly) */
    .shot.hit{border-color:rgba(34,197,94,.30)}
    .shot.miss{border-color:rgba(239,68,68,.26)}

    /* Live grid: color rules */
    .shot.hit1{
      border-color: rgba(34,197,94,.30);
      color: var(--g1);
    }
    .shot.hit2{
      border-color: rgba(234,179,8,.45); /* amber glow */
      color: var(--orange);
    }
    .shot.miss1{
      border-color: rgba(239,68,68,.26);
      color: var(--r1);
    }
    
    /* Make the small meta text inherit the same color, just lighter */
    .shot .meta{
      color: currentColor;
      opacity: .75;
    }

    .shot .zoneTxt{ font-size:18px; font-weight:950; }

    /* ================================
   Live grid ‚Äî colored backgrounds
   ================================ */

    /* Base cell */
    .shot{
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      transition: background .15s ease, border-color .15s ease;
    }
    
    /* üü¢ Hit ‚Äì 1st shot */
    .shot.hit1{
      background: linear-gradient(
        180deg,
        rgba(34,197,94,.14),
        rgba(34,197,94,.04)
      );
      border-color: rgba(34,197,94,.35);
      color: var(--g1);
    }
    
    /* üü° Hit ‚Äì 2nd shot */
    .shot.hit2{
      background: linear-gradient(
        180deg,
        rgba(234,179,8,.18),
        rgba(234,179,8,.05)
      );
      border-color: rgba(234,179,8,.45);
      color: var(--orange);
    }
    
    /* üî¥ Miss (always 2nd shot) */
    .shot.miss1{
      background: linear-gradient(
        180deg,
        rgba(239,68,68,.16),
        rgba(239,68,68,.05)
      );
      border-color: rgba(239,68,68,.35);
      color: var(--r1);
    }
    
    /* Text inherits color, just softer */
    .shot .meta{
      color: currentColor;
      opacity: .75;
    }



    /* 5-zone tap stacks */
    .zonePanel{display:grid;gap:10px}
    .zoneHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .seg{
      display:inline-flex;
      border:1px solid var(--border);
      background:#0f1013;
      border-radius:999px;
      overflow:hidden;
    }
    .seg button{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:8px 12px;
      font-weight:950;
      cursor:pointer;
      min-width:74px;
    }
    .seg button.active{
      background:#1c1f26;
      color:var(--text);
    }

    .zoneGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .zoneBtn{
      padding:9px 9px;
      border-radius:16px;
      border:2px solid var(--border);
      font-weight:950;
      font-size:35px;
      min-height:62px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 8px 20px rgba(0,0,0,.22);
    }
    .zoneBtn small{font-size:9px;font-weight:900;opacity:.85}

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .iconBtn{
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0f1118;
      color:var(--text);
      font-size:18px;
      font-weight:950;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{transform:scale(.99)}
    
    .modalBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modalBackdrop.open{display:flex}
    
    .modalCard{
      width:min(620px, 96vw);
      background:rgba(18,20,26,.97);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px;
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .profilesList{
      display:grid;
      gap:10px;
    }
    .profileRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#0f1118;
    }
    .profileName{
      font-weight:950;
    }
    .profileActions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .smallMuted{font-size:12px;color:var(--muted)}


    /* Hit shades per zone */
    .hitHL{background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.30); color:var(--g4)}
    .hitSL{background:rgba(74,222,128,.12); border-color:rgba(74,222,128,.30); color:var(--g3)}
    .hitC {background:rgba(34,197,94,.12);  border-color:rgba(34,197,94,.30);  color:var(--g1)}
    .hitSR{background:rgba(134,239,172,.10);border-color:rgba(134,239,172,.26); color:var(--g5)}
    .hitHR{background:rgba(22,163,74,.12);  border-color:rgba(22,163,74,.30);  color:var(--g2)}

    /* Miss shades per zone */
    .missHL{background:rgba(220,38,38,.12); border-color:rgba(220,38,38,.28); color:var(--r2)}
    .missSL{background:rgba(248,113,113,.10);border-color:rgba(248,113,113,.25); color:var(--r3)}
    .missC {background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.25); color:var(--r1)}
    .missSR{background:rgba(251,113,133,.10);border-color:rgba(251,113,133,.25); color:var(--r4)}
    .missHR{background:rgba(254,202,202,.08);border-color:rgba(254,202,202,.22); color:var(--r1)}

    /* Badges */
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border); border-radius:999px; padding:6px 10px;
      background:#0f1118; font-size:12px; font-weight:900;
    }
    .badge strong{font-weight:950}
    .badge.zHL{border-color:rgba(239,68,68,.35)}
    .badge.zSL{border-color:rgba(248,113,113,.35)}
    .badge.zC {border-color:rgba(249,115,22,.35)}
    .badge.zSR{border-color:rgba(234,179,8,.35)}
    .badge.zHR{border-color:rgba(239,68,68,.35)}

    /* Best/Worst pills */
    .pillScore{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:#0f1118;font-size:12px;font-weight:950;
      margin-right:6px;
      white-space:nowrap;
    }
    .pillScore.good{border-color:rgba(34,197,94,.35); color:var(--g1)}
    .pillScore.mid{border-color:rgba(249,115,22,.35); color:var(--orange)}
    .pillScore.low{border-color:rgba(239,68,68,.35); color:var(--r1)}

    /* Saved rounds list */
    .list{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){ .list{grid-template-columns:1fr 1fr} }
    .round{border:1px solid var(--border);border-radius:18px;overflow:hidden;background:#0f1118}
    .roundHead{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px}
    .meta2{font-size:12px;color:var(--muted)}
    .mini{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px}
    .box{border:1px solid var(--border);border-radius:16px;padding:10px}
    .box .k{font-size:11px;color:var(--muted)}
    .box .v{font-size:18px;font-weight:950;margin-top:4px}
    .g{background:rgba(34,197,94,.08)} .rr{background:rgba(239,68,68,.08)}
    .oo{background:rgba(249,115,22,.08)} .yy{background:rgba(234,179,8,.08)}
    .notes{padding:12px;color:#d7def0;font-size:13px;white-space:pre-wrap}

    /* ===== Loader overlay ===== */
    .loader{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg, #05060a, #07080c);
      z-index:99999;
    }
    .loaderCard{
      width:min(420px, 92vw);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:22px 18px;
      background:rgba(10,11,16,.65);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      text-align:center;
      backdrop-filter: blur(10px);
    }
    .loaderIcon{
      font-size:42px;
      line-height:1;
      margin-bottom:10px;
    }
    .loaderTitle{
      font-weight:950;
      font-size:18px;
      letter-spacing:.2px;
    }
    .loaderSub{
      margin-top:6px;
      font-size:12px;
      color: rgba(255,255,255,.55);
    }
    
    /* tiny animated dots */
    .loaderSub:after{
      content:"";
      display:inline-block;
      width:14px;
      text-align:left;
      animation: dots 1.2s steps(4,end) infinite;
    }
    @keyframes dots{
      0%{content:"";}
      25%{content:".";}
      50%{content:"..";}
      75%{content:"...";}
      100%{content:"";}
    }
    
    /* hide animation */
    .loader.hide{
      opacity:0;
      pointer-events:none;
      transition: opacity .22s ease;
    }

    /* ‚úÖ Prevent flex/grid children from overflowing/overlapping */
    .row > * { min-width: 0; }           /* IMPORTANT */
    input, select, textarea { min-width: 0; }
    
    /* ‚úÖ iOS/Safari date input: prevents weird internal overflow */
    input[type="date"]{
      -webkit-appearance: none;
      appearance: none;
      text-align: left;                 /* avoids centered text clipping */
      padding-right: 44px;              /* space for calendar icon */
    }
    
    /* (optional) keep the calendar icon visible + aligned */
    input[type="date"]::-webkit-calendar-picker-indicator{
      opacity: .75;
      cursor: pointer;
    }
    
    /* ‚úÖ Saved Rounds filters: don‚Äôt force 4 columns on small screens */
    .filters{
      display: grid;
      gap: 10px;
    }

    /* 4-column filters layout (Saved Rounds + Overview) */
    .filters{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      align-items:end;
    }
    .filters > div{min-width:0;}
    
    /* Tablet */
    @media (max-width: 900px){
      .filters{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    
    /* Phone */
    @media (max-width: 520px){
      .filters{ grid-template-columns:1fr; }
    }

    .cartridgeSection{
      margin:14px 0;   /* separation without divider lines */
    }

    .profileActions .btn{
      padding:8px 10px;
      min-width:auto;
    }

    /* =========================
   PAGES (Main / Competition)
   ========================= */
    .page{display:block;}
    .page.hidden{display:none;}
    
    .pageTopbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    
    .bigNavBtn{
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      font-size:15px;
      font-weight:950;
      justify-content:center;
    }
    
    .bigNavBtn{
      background:#0f3d2e;
      border:2px solid #1e6f55;
      color:#eafff6;
    }
    
    .bigNavBtn:active{
      transform:scale(.99);
    }
   
    #openCompBtn{
      background:linear-gradient(180deg,#1f2937,#0b1220);
      border:2px solid rgba(59,130,246,.45);
      color:#93c5fd;
      box-shadow:
        0 8px 24px rgba(0,0,0,.45),
        inset 0 0 0 1px rgba(59,130,246,.2);
    }
        
    .compCard{
      border:1px solid var(--border);
      background:#0f1118;
      border-radius:18px;
      padding:12px;
    }
    
    .compHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    
    .compTitle{
      font-weight:950;
      font-size:15px;
    }
    
    .compMeta{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    
    .compRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
    }
    
    .compBadges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    
    .compTiny{
      font-size:12px;
      color:var(--muted);
    }
    
    .compRoundsLine{
      margin-top:10px;
      font-size:12px;
      color:var(--text);
      opacity:.92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    .compFormGrid{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      align-items:end;
    }
    @media (max-width: 900px){
      .compFormGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .compFormGrid{ grid-template-columns: 1fr; }
    }
    
    .roundInputs{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(5, minmax(0, 1fr));
    }
    @media (max-width: 900px){
      .roundInputs{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .roundInputs{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    
    .roundInputs .ri label{
      margin-bottom:6px;
    }
    
    .roundInputs input[type="number"]{
      text-align:center;
      font-weight:950;
    }
    
    .themePill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background:#0f1118;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    
    .themeDot{
      width:10px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.35);
    }
    
    .compThemeBlue .compAccent{
      border-color:rgba(0,208,255,.25) !important;
      background:rgba(0,208,255,.06) !important;
    }

    /* =========================
   TABS (Live / Overview / Comp+Saved)
   ========================= */
  .tabsBar{
    display:flex;
    gap:10px;
    margin:12px 0 14px;
    padding:6px;
    border:1px solid var(--border);
    background:#0f1118;
    border-radius:18px;
  }
  .tabBtn{
    flex:1;
    border:0;
    background:transparent;
    color:var(--muted);
    padding:12px 10px;
    border-radius:14px;
    font-weight:950;
    cursor:pointer;
  }
  .tabBtn.active{
    background:#1c1f26;
    color:var(--text);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
  }
  
  .tabPage{display:none;}
  .tabPage.active{display:block;}

  /* =========================
   TABS
   ========================= */
  .tabsBar{
    display:flex;
    gap:10px;
    margin:10px 0 12px;
    padding:8px;
    border:1px solid var(--border);
    border-radius:18px;
    background:#0f1118;
    position:sticky;
    top:10px;
    z-index:50;
    backdrop-filter: blur(10px);
  }
  
  .tabBtn{
    flex:1;
    border:1px solid transparent;
    background:transparent;
    color:var(--muted);
    padding:10px 12px;
    border-radius:14px;
    font-weight:950;
    cursor:pointer;
    user-select:none;
    min-width:0;
  }
  
  .tabBtn.active{
    color:var(--text);
    background:#1c1f26;
    border-color:rgba(255,255,255,.10);
    box-shadow: inset 0 0 0 1px rgba(120,130,255,.12);
  }
  
  .tabPanel{display:block;}
  .tabPanel.hidden{display:none;}

  /* Stop iOS double-tap zoom + reduce accidental page move */
  html, body { overscroll-behavior: none; }
  .zoneBtn, .btn, .tabBtn, .iconBtn { touch-action: manipulation; }

  /* Misses diagram card gets a photo background */
  #missDiagramStat{
    position: relative;
    overflow: hidden;
  
    background: url("./trap-bg.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  
  /* Make the 5 top values purple (instead of red/yellow mix) */
  #missDiagramStat .missVal{
    color: var(--purple) !important;
  }
  
  /* Make all diagram lines purple */
  #missDiagramStat svg path{
    stroke: var(--purple) !important;
  }
  
  /* Optional: if you want the small HL/SL/C/SR/HR labels to stay readable */
  #missDiagramStat svg text{
    fill: rgba(255,255,255,.70) !important;
  }



  </style>
</head>

<body>

  <!-- LOADER OVERLAY -->
  <div id="appLoader" class="loader" aria-hidden="false">
    <div class="loaderCard">
      <div class="loaderIcon">üéØ</div>
      <div class="loaderTitle">TrapPerformance</div>
      <div class="loaderSub">Loading‚Ä¶</div>
    </div>
  </div>

  <div class="wrap">

    <!-- TOP BAR -->
    <div class="topbar">
      <div>
        <h1>Olympic Trap Performance</h1>
        <p class="sub" id="activeProfileLine"></p>
      </div>

      <button class="iconBtn" id="profileBtn" type="button" title="Profiles">üë§</button>
    </div>

    <!-- TABS -->
    <div class="tabsBar" role="tablist">
      <button class="tabBtn active" id="tabLiveBtn">Live</button>
      <button class="tabBtn" id="tabOverviewBtn">Performance</button>
      <button class="tabBtn" id="tabSavedBtn">Saved</button>
      <button class="tabBtn" id="tabCompBtn">Competition</button>
    </div>


    <!-- ======================
         TAB 1 ‚Äî LIVE ROUND
         ====================== -->
    <section id="panelLive" class="tabPanel" role="tabpanel" aria-labelledby="tabLiveBtn">
      <div class="grid">
        <!-- LIVE ROUND -->
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:950;font-size:16px">Live Round Mode</div>
              <div class="small" id="statusLine">Ready.</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn" id="undoBtn">‚Ü©Ô∏é Undo</button>
              <button class="btn danger" id="resetRoundBtn">Reset round</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="statgrid">
            <div class="stat"><div class="k">Score</div><div class="v" id="scoreV">0/25</div></div>
            <div class="stat"><div class="k">Target</div><div class="v" id="shotV">0/25</div></div>
            <div class="stat"><div class="k">Hit %</div><div class="v" id="hitPctV">0%</div></div>
            <div class="stat">
              <div class="k">2nd shot</div>
              <div class="v" id="shot2CountV">0</div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- MIC MODE -->
          <div class="card" style="margin:10px 0;background:#0f1118">
            <div class="row" style="justify-content:space-between; align-items:center">
              <div>
                <div style="font-weight:950">Mic mode</div>
                <div class="small" id="micStatus">Off</div>
              </div>
              <div class="row" style="gap:8px">
                <button class="btn primary" id="micArmBtn" type="button">üéôÔ∏è ARM</button>
                <button class="btn" id="micStopBtn" type="button" disabled>Stop</button>
                <button class="btn danger" id="micResetBtn" type="button" disabled>Reset</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row" style="justify-content:space-between; gap:10px">
              <div class="small">
                Call‚ÜíShot reaction: <b id="reactV">‚Äî</b>
                <span style="opacity:.65"> ‚Ä¢ Shot auto: </span><b id="autoShotV">‚Äî</b>
              </div>

              <div class="row" style="gap:8px; align-items:center">
                <div style="min-width:140px">
                  <label style="margin:0 0 6px">Sensitivity</label>
                  <input id="micSens" type="number" min="1" max="100" value="35" />
                </div>
                <div style="min-width:160px">
                  <label style="margin:0 0 6px">2nd shot window (ms)</label>
                  <input id="shot2Win" type="number" min="600" max="2500" value="1600" />
                </div>
              </div>
            </div>

            <div class="hint" style="margin-top:8px">
              Tap ARM, call ‚Äúah‚Äù, then shoot. Best with phone on chest pocket.
            </div>
          </div>

          <div class="zonePanel">
            <div class="zoneHeader">
              <div class="small"></div>


              <div class="row" style="gap:8px; margin-top:8px">
                <button class="btn" id="autoShotBtn" type="button">Auto shot: ON</button>
                <div class="hint">Mic detection assigns 1st/2nd shot when available</div>
              </div>
            </div>

            <!-- HITS -->
            <div class="zoneGrid" id="hitGrid">
              <button class="zoneBtn hitHL" data-out="H" data-zone="HL">‚Üê<small></small></button>
              <button class="zoneBtn hitSL" data-out="H" data-zone="SL">‚Üñ<small></small></button>
              <button class="zoneBtn hitC"  data-out="H" data-zone="C">‚Üë<small></small></button>
              <button class="zoneBtn hitSR" data-out="H" data-zone="SR">‚Üó<small></small></button>
              <button class="zoneBtn hitHR" data-out="H" data-zone="HR">‚Üí<small></small></button>
            </div>

            <!-- MISSES -->
            <div class="zoneGrid" id="missGrid">
              <button class="zoneBtn missHL" data-out="M" data-zone="HL">‚Üê<small></small></button>
              <button class="zoneBtn missSL" data-out="M" data-zone="SL">‚Üñ<small></small></button>
              <button class="zoneBtn missC"  data-out="M" data-zone="C">‚Üë<small></small></button>
              <button class="zoneBtn missSR" data-out="M" data-zone="SR">‚Üó<small></small></button>
              <button class="zoneBtn missHR" data-out="M" data-zone="HR">‚Üí<small></small></button>
            </div>
          </div>

          <div class="shotsWrap">
            <div class="row" style="justify-content:space-between; margin-top:12px">
              <div class="row" style="gap:10px">
                <div class="pill"><span class="dot" style="background:var(--g1)"></span>Hit</div>
                <div class="pill"><span class="dot" style="background:var(--r1)"></span>Miss</div>
                <div class="pill"><span class="dot" style="background:var(--orange)"></span>2nd Hit</div>
              </div>
              <div class="small"></div>
            </div>

            <div class="shotGrid" id="shotGrid" style="margin-top:10px"></div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div style="flex:1;min-width:130px">
              <label>Date</label>
              <input id="date" type="date" />
            </div>
            <div style="flex:1;min-width:140px">
              <label>Club</label>
              <input id="club" list="clubList" placeholder="Rabat, Umbriaverde" />
              <datalist id="clubList"></datalist>
            </div>
            <div style="flex:1;min-width:5px">
              <label>Field</label>
              <input id="field" placeholder="1, 2" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1;min-width:160px">
              <label>Notes</label>
              <textarea id="notes" placeholder="Wind, light, ammo, focus cue, what felt off..."></textarea>
            </div>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:8px">
            <div class="small">When you reach 25/25, you can save the round.</div>
            <button class="btn primary" id="saveRoundBtn">Save round</button>
          </div>
        </div>

        <!-- (Optional spacer card on the right in desktop grid)
             If you want Live Round to stay wide, keep grid with single column:
             Otherwise you can add a second card here later. -->
      </div>
    </section>

    <!-- ======================
         TAB 2 ‚Äî OVERVIEW
         ====================== -->
    <section id="panelOverview" class="tabPanel hidden" role="tabpanel" aria-labelledby="tabOverviewBtn">
      <div class="grid">
        <!-- OVERVIEW -->
        <div class="card">
          <div style="font-weight:950;font-size:16px">Overview</div>
          <div class="small" id="overviewSubtitle">Simple stats for the selected period</div>

          <div class="divider"></div>

          <div class="filters filters--overview">
            <div>
              <label>Time range</label>
              <select id="rangeSel">
                <option value="today">Today</option>
                <option value="week">This week</option>
                <option value="month" selected>This month</option>
                <option value="last3">Last 3 months</option>
                <option value="last6">Last 6 months</option>
                <option value="year">This year</option>
                <option value="all">All time</option>
                <option value="monthPick">Past month‚Ä¶</option>
              </select>
            </div>

            <div>
              <label>Past months</label>
              <select id="monthSel" disabled>
                <option value="">Select month‚Ä¶</option>
              </select>
            </div>

            <div>
              <label>Club</label>
              <select id="clubSel">
                <option value="all">All clubs</option>
              </select>
            </div>

            <div>
              <label>Field</label>
              <select id="fieldSel">
                <option value="all">All fields</option>
              </select>
            </div>
          </div>

          <div class="hint" style="margin-top:8px">
            Past months is only active when ‚ÄúPast month‚Äù is selected.
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between; gap:10px">
            <div class="row" style="gap:10px; flex-wrap:wrap">
              <span class="badge" id="mostMissedBadge" style="display:none"></span>
              <span class="badge" id="insightBadge" style="display:none"></span>
            </div>
            <div class="small" id="rangeCount">0 rounds</div>
          </div>

          <div style="height:10px"></div>

          <div class="statgrid" style="grid-template-columns:repeat(3,minmax(0,1fr))">
            <div class="stat">
              <div class="k">Average</div>
              <div class="v" id="avgHits">0.0/25</div>
              <div class="s" id="avgHitsSub">Avg hit %: 0%</div>
            </div>

            <div class="stat">
              <div class="k">Best / Worst</div>
              <div class="v" id="bestWorst">‚Äî</div>
            </div>

            <div class="stat">
              <div class="k">Last 10 rounds</div>
              <div class="v" id="last10">‚Äî</div>
              <div class="s" id="last10Sub">Avg hits (if ‚â•10)</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="statgrid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
            <div class="stat">
              <div class="k">1st shot reaction</div>
              <div class="v" id="avgRT1">‚Äî</div>
              <div class="s" id="rt1Sub">Consistency: ‚Äî</div>
            </div>

            <div class="stat">
              <div class="k">2nd shot reaction</div>
              <div class="v" id="avgRT2">‚Äî</div>
              <div class="s" id="rt2Sub">Consistency: ‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

           <div class="stat" style="background:#000D0D">
            <div class="k">Average misses per round (by zone)</div>

            <div class="row" style="justify-content:space-between; align-items:flex-start; gap:10px; margin-top:8px">
              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--r2);font-size:18px" id="avgMHL">0.0</div>
                <div class="small">HL</div>
              </div>
              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--b1);font-size:18px" id="avgMSL">0.0</div>
                <div class="small">SL</div>
              </div>
              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--p1);font-size:18px" id="avgMC">0.0</div>
                <div class="small">C</div>
              </div>
              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--b1);font-size:18px" id="avgMSR">0.0</div>
                <div class="small">SR</div>
              </div>
              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--r2);font-size:18px" id="avgMHR">0.0</div>
                <div class="small">HR</div>
              </div>
            </div>

            <svg viewBox="0 0 360 100" width="100%" height="100" style="margin-top:8px">
              <circle cx="180" cy="86" r="7" fill="#0f1118" stroke="var(--border)" stroke-width="2"/>
              <path d="M180 86 C130 70, 90 50, 50 18" fill="none" stroke="var(--r2)" stroke-width="6" stroke-linecap="round"/>
              <path d="M180 86 C150 66, 125 46, 100 18" fill="none" stroke="var(--b1)" stroke-width="6" stroke-linecap="round"/>
              <path d="M180 86 C180 60, 180 40, 180 14" fill="none" stroke="var(--p1)" stroke-width="6" stroke-linecap="round"/>
              <path d="M180 86 C210 66, 235 46, 260 18" fill="none" stroke="var(--b1)" stroke-width="6" stroke-linecap="round"/>
              <path d="M180 86 C230 70, 270 50, 310 18" fill="none" stroke="var(--r2)" stroke-width="6" stroke-linecap="round"/>
              <text x="52" y="16" fill="var(--muted)" font-size="11" font-weight="900">HL</text>
              <text x="100" y="16" fill="var(--muted)" font-size="11" font-weight="900">SL</text>
              <text x="176" y="12" fill="var(--muted)" font-size="11" font-weight="900">C</text>
              <text x="258" y="16" fill="var(--muted)" font-size="11" font-weight="900">SR</text>
              <text x="310" y="16" fill="var(--muted)" font-size="11" font-weight="900">HR</text>
            </svg>

            <div class="s" id="missDiagramSub">Based on selected period</div>
          </div>

          <div class="divider"></div>

          <div class="stat" id="avgDirStat" style="background:#000D0D">
            <div class="k">Average misses per round (by direction)</div>

            <div class="row" style="justify-content:space-between; align-items:flex-start; gap:10px; margin-top:8px">
              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--r1);font-size:18px" id="avgDirL">0.0</div>
                <div class="small">LEFT</div>
              </div>

              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--r3);font-size:18px" id="avgDirC">0.0</div>
                <div class="small">CENTER</div>
              </div>

              <div style="flex:1;text-align:center">
                <div style="font-weight:950;color:var(--r2);font-size:18px" id="avgDirR">0.0</div>
                <div class="small">RIGHT</div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="stat" id="secondShotStat" style="background:rgba(234,179,8,.08); border-color:rgba(234,179,8,.28)">
            <div class="k">2nd Shot reliance</div>
            <div class="v" id="avgShot2">0.0/25</div>
            <div class="s" id="avgShot2Sub">Avg per round (selected period)</div>
          </div>

          <div class="divider"></div>

          <div class="stat" style="background:#000D0D">
            <div class="k">Score trend (selected period)</div>
            <div class="s" id="scoreTrendSub">‚Äî</div>

            <svg id="scoreTrendSvg" viewBox="0 0 360 140" width="100%" height="140" style="margin-top:8px">
              <path d="M30 10 V120 H350" fill="none" stroke="var(--border)" stroke-width="2" />
              <g id="scoreTrendGrid"></g>
              <g id="scoreTrendYLabels"></g>
              <path id="scoreTrendPath" d="" fill="none" stroke="#3b82f6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              <g id="scoreTrendDots"></g>
            </svg>
          </div>

          <div class="divider"></div>

          <div class="small">
            Goal: reduce your <b>most missed zone</b> first ‚Äî it usually gives the fastest improvement.
          </div>
        </div>

        <!-- CARTRIDGES (ALL-TIME) -->
        <div class="card" style="background:rgba(0,208,255,.06); border-color:rgba(0,208,255,.22)">
          <div style="font-weight:950;font-size:16px">Cartridges burned üî•</div>

          <div class="row" style="justify-content:space-between; align-items:center; gap:12px; margin-top:10px">
            <div>
              <div class="v" id="cartridgeTotal" style="font-size:34px;font-weight:950">0</div>
            </div>

            <div class="row" style="gap:8px; align-items:center">
              <input id="cartridgeStep" type="number" min="1" value="25" style="width:90px" />
              <button class="btn" id="cartridgeMinus" type="button">‚àí Remove</button>
              <button class="btn" id="cartridgePlus" type="button">+ Add</button>
            </div>
          </div>
        </div>
      </div>
    </section>


    <section id="panelSaved" class="tabPanel hidden">
      <!-- SAVED ROUNDS -->
      <div class="card" style="background:#111214">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:950;font-size:16px">Saved Rounds</div>
            <div class="small" id="countLine">0 total</div>
          </div>

          <div class="row" style="gap:8px; align-items:flex-end">
            <div style="min-width:130px">
              <label style="margin:0 0 6px"></label>
              <input id="savedDate" type="date" disabled />
            </div>

            <button class="btn primary" id="exportPdfBtn" type="button">Export PDF</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="filters" style="display:grid;gap:5px;grid-template-columns: 1fr 1fr 1fr;">
          <div>
            <label>Show</label>
            <select id="savedRange">
              <option value="today">Today</option>
              <option value="week">This week</option>
              <option value="month" selected>This month</option>
              <option value="last3">Last 3 months</option>
              <option value="last6">Last 6 months</option>
              <option value="year">This year</option>
              <option value="all">All rounds</option>
              <option value="day">A specific day‚Ä¶</option>
            </select>
          </div>

          <div>
            <label>Club</label>
            <select id="savedClub">
              <option value="all">All clubs</option>
            </select>
          </div>

          <div>
            <label>Field</label>
            <select id="savedField">
              <option value="all">All fields</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list" id="list"></div>
        <div id="empty" class="small" style="display:none;margin-top:10px">No rounds found for these filters.</div>
      </div>
      </div>
    </section>
   
    <!-- ======================
         TAB 3 ‚Äî COMPETITION 
         ====================== -->
    <section id="panelComp" class="tabPanel hidden">

      <!-- COMPETITION LOG -->
      <div class="pageTopbar" style="margin-top:4px">
        <div>
          <h1 style="margin:6px 0 2px">Competition Log</h1>
          <p class="sub">Olympic Trap</p>
        </div>
      </div>

      <!-- CONTROLS -->
      <div class="card compAccent" id="compControlsCard">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:950;font-size:16px">Competitions</div>
            <div class="small" id="compCountLine">0 total</div>
          </div>

          <div class="row" style="gap:8px">
            <button class="btn primary" id="newCompBtn" type="button">+ New Event</button>
          </div>
        </div>
      </div>

      <!-- FORM (Add/Edit) -->
      <div class="card compAccent" id="compFormCard" style="display:none; margin-top:12px">
        <div class="row" style="justify-content:space-between; gap:10px">
          <div>
            <div style="font-weight:950;font-size:16px" id="compFormTitle">New competition</div>
            <div class="small" id="compFormSub">Default 5 rounds ‚Ä¢ You can leave rounds blank and fill later</div>
          </div>

          <div class="row" style="gap:8px">
            <button class="btn" id="cancelCompBtn" type="button">Cancel</button>
            <button class="btn primary" id="saveCompBtn" type="button">Save</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="compFormGrid">
          <div>
            <label>Competition name</label>
            <input id="compName" placeholder="e.g., Tangier GP" />
          </div>

          <div>
            <label>Date</label>
            <input id="compDate" type="date" />
          </div>

          <div>
            <label>Club</label>
            <input id="compClub" placeholder="e.g., Tangier Club" />
          </div>

          <div>
            <label>Number of rounds</label>
            <input id="compRoundsCount" type="number" min="1" max="10" value="5" />
            <div class="hint">Default is 5 (125). Use fewer/more only if needed.</div>
          </div>

          <div>
            <label>Final played?</label>
            <select id="compFinalPlayed">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </div>

          <div id="finalScoreWrap" style="display:none">
            <label>Final score</label>
            <input id="compFinalScore" type="number" min="0" max="200" placeholder="Enter final score" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="small" style="margin-bottom:8px">Qualification rounds (0‚Äì25 each)</div>
        <div class="roundInputs" id="compRoundInputs"></div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between; gap:10px">
          <div class="small" id="compTotalsLine">Total: 0 ‚Ä¢ Rounds filled: 0/5</div>
          <div class="small"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Notes (optional)</label>
            <textarea id="compNotes" placeholder="Anything important about this competition‚Ä¶"></textarea>
          </div>
        </div>
      </div>

      <!-- LIST -->
      <div class="card compAccent" style="margin-top:12px">
        <div class="list" id="compList" style="grid-template-columns:1fr"></div>
        <div id="compEmpty" class="small" style="display:none;margin-top:10px">No competitions yet. Tap ‚Äú+ New‚Äù.</div>
      </div>
      
    </section>

  </div><!-- /.wrap -->

  <!-- PROFILES MODAL (unchanged) -->
  <div class="modalBackdrop" id="profileModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Profiles">
      <div class="modalHead">
        <div>
          <div style="font-weight:950;font-size:16px">Profiles</div>
          <div class="small">Switch, add, or remove profiles</div>
        </div>
        <button class="btn" id="closeProfileModal" type="button">‚úï</button>
      </div>

      <div class="divider"></div>

      <div class="small" style="margin-bottom:8px">Active profile</div>
      <div id="profilesList" class="profilesList"></div>

      <div class="divider"></div>

      <div class="row" style="gap:8px; justify-content:flex-end; flex-wrap:wrap">
        <button class="btn" id="exportProfileJsonBtn" type="button">Export Profile</button>
        <button class="btn" id="importProfileJsonBtn" type="button">Import Profile</button>
        <input id="importProfileFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="divider"></div>

      <div class="row" style="gap:8px; align-items:center">
        <input id="newProfileName" placeholder="New profile name (e.g. Aamr, Pellielo)" />
        <button class="btn primary" id="addProfileBtn" type="button">+ Add</button>
      </div>

      <div class="hint" style="margin-top:10px"></div>
    </div>
  </div>



<script>
  const $ = (id) => document.getElementById(id);

  // =========================
  // Tabs (Live / Overview / Competition+Saved)
  // =========================
  function setActiveTab(tab){
    const tabs = [
      { key:"live",     btn:tabLiveBtn,     panel:panelLive },
      { key:"overview", btn:tabOverviewBtn, panel:panelOverview },
      { key:"saved",    btn:tabSavedBtn,    panel:panelSaved },
      { key:"comp",     btn:tabCompBtn,     panel:panelComp },
    ];
  
    tabs.forEach(t=>{
      const on = t.key === tab;
      t.btn.classList.toggle("active", on);
      t.panel.classList.toggle("hidden", !on);
    });
  
    // Refresh data only when needed
    if(tab === "saved") renderSavedRounds();
    if(tab === "comp"){
      competitions = loadCompetitions();
      applyCompThemeToCards();
      renderCompList();
    }
  }

  
  $("tabLiveBtn").addEventListener("click", ()=> setActiveTab("live"));
  $("tabOverviewBtn").addEventListener("click", ()=> setActiveTab("overview"));
  $("tabCompBtn").addEventListener("click", ()=> setActiveTab("comp"));


  // ---- Profiles storage ----
  const PROFILES_KEY = "trap_tracker_profiles_v1";
  const ACTIVE_PROFILE_KEY = "trap_tracker_active_profile_v1";
  
  // Base prefix for per-profile data
  const KEY_PREFIX = "trap_tracker_live_issf_v4_zones";
  
  // Dynamic keys (change when profile changes)
  let KEY = "";
  let CART_KEY = "";

  // Competitions key (per profile)
  let COMP_KEY = "";
  
  // Competition theme key (global or per profile ‚Äî we‚Äôll do per profile)
  let COMP_THEME_KEY = "";

  
  // Active profile object {id, name}
  let activeProfile = null;
  
  function uid(){
    return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,9)}`;
  }
  
  function loadProfiles(){
    try{
      const raw = localStorage.getItem(PROFILES_KEY);
      const list = raw ? JSON.parse(raw) : null;
      if(Array.isArray(list) && list.length) return list;
    }catch{}
    // default
    const def = [{ id: "main", name: "Main" }];
    localStorage.setItem(PROFILES_KEY, JSON.stringify(def));
    return def;
  }
  
  function saveProfiles(list){
    localStorage.setItem(PROFILES_KEY, JSON.stringify(list));
  }
  
  function getActiveProfileId(){
    return localStorage.getItem(ACTIVE_PROFILE_KEY) || "main";
  }
  
  function setActiveProfileId(id){
    localStorage.setItem(ACTIVE_PROFILE_KEY, id);
  }
  
  function makeKey(profileId){
    return `${KEY_PREFIX}__${profileId}`;
  }

  // ---- Initial defaults (run once) ----
  $("rangeSel").value = "month";
  $("savedRange").value = "month";
  
  function applyProfile(profileId){
    const profiles = loadProfiles();
    const found = profiles.find(p => p.id === profileId) || profiles[0];
    activeProfile = found;
  
    setActiveProfileId(found.id);
  
    KEY = makeKey(found.id);
    CART_KEY = KEY + "_cartridge_manual";
    COMP_KEY = KEY + "_competitions";
    COMP_THEME_KEY = KEY + "_comp_theme";

  
    // reload per-profile rounds
    rounds = load();
    competitions = loadCompetitions();
    // reset live round UI but keep data safe
    liveTargets = [];
    $("notes").value = "";
    $("club").value = "";
    $("field").value = "";
  
    // update header line
    $("activeProfileLine").textContent = `Profile: ${found.name}`;
  
    renderAll();
    setActiveTab("live");
    hideLoader();
  }


  function loadCartridgeManual(){
    const raw = localStorage.getItem(CART_KEY);
    const n = raw ? Number(raw) : 0;
    return Number.isFinite(n) ? Math.max(0, Math.floor(n)) : 0;
  }
  function saveCartridgeManual(n){
    localStorage.setItem(CART_KEY, String(Math.max(0, Math.floor(n))));
  }


  const pct = (a,b)=> b? Math.round((a/b)*1000)/10 : 0;

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  $("date").value = todayISO();
  $("savedDate").value = todayISO();

 
  function escapeHtml(s){
    return String(s).replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"\"":'&quot;',"'":'&#39;'}[c]));
  }

  function startOfWeek(d){
    const x = new Date(d);
    const day = (x.getDay() + 6) % 7; // Monday = 0
    x.setDate(x.getDate() - day);
    x.setHours(0,0,0,0);
    return x;
  }
  function startOfMonth(d){
    const x = new Date(d.getFullYear(), d.getMonth(), 1);
    x.setHours(0,0,0,0);
    return x;
  }
  function startOfYear(d){
    const x = new Date(d.getFullYear(), 0, 1);
    x.setHours(0,0,0,0);
    return x;
  }
  function addMonths(d, n){
    const x = new Date(d);
    x.setMonth(x.getMonth() + n);
    return x;
  }
  function parseISODate(iso){
    const [y,m,dd] = (iso||"").split("-").map(Number);
    if(!y||!m||!dd) return null;
    const x = new Date(y, m-1, dd);
    x.setHours(0,0,0,0);
    return x;
  }
  function monthKey(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }
  function monthLabel(key){
    const [y,m] = key.split("-").map(Number);
    const names = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${names[m-1]} ${y}`;
  }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      const list = raw ? JSON.parse(raw) : [];
      return Array.isArray(list) ? list : [];
    }catch{ return []; }
  }
  function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

  // LIVE ROUND STATE (25 targets): each entry is {out:'H'|'M', zone:'HL'|'SL'|'C'|'SR'|'HR', shot:1|2}
  let liveTargets = [];
  let rounds = load();

  const ZONES = ["HL","SL","C","SR","HR"];

  function blankZoneObj(){
    return {HL:0, SL:0, C:0, SR:0, HR:0};
  }
  
  function mean(arr){
    return arr.length ? arr.reduce((s,x)=>s+x,0)/arr.length : null;
  }
  function std(arr){
    if(arr.length < 2) return null;
    const m = mean(arr);
    const v = arr.reduce((s,x)=>s+(x-m)*(x-m),0)/(arr.length-1);
    return Math.sqrt(v);
  }
  function fmtSec(ms){
    return (ms/1000).toFixed(2) + "s";
  }

  function countsFromTargets(targets){
    const hitZone = blankZoneObj();
    const missZone = blankZoneObj();
    let hit=0, miss=0, shot1=0, shot2=0;

    for(const t of targets){
      if(!t) continue;
      if(t.shot === 1) shot1++;
      if(t.shot === 2) shot2++;

      if(t.out === "H"){
        hit++;
        if(hitZone[t.zone] !== undefined) hitZone[t.zone]++;
      } else if(t.out === "M"){
        miss++;
        if(missZone[t.zone] !== undefined) missZone[t.zone]++;
      }
    }
    return {targets:25, hit, miss, shot1, shot2, hitZone, missZone};
  }

  function stationIndexFromTargetIndex(i){
    return Math.min(4, Math.floor(i/5));
  }


  /* =========================
   MIC: call ‚Üí shot1 ‚Üí shot2
   ========================= */
  
  let mic = {
    enabled: false,
    ctx: null,
    stream: null,
    src: null,
    analyser: null,
    raf: 0,
  
    baseline: 0,
    smooth: 0,
  
    state: "OFF", // OFF | WAIT_CALL | WAIT_SHOT1 | WAIT_SHOT2
    callTime: 0,
    shot1Time: 0,
    shot2Time: 0,
    reactionMs: null,
    autoShot: 1,
  
    lastEventAt: 0,
    shot1LockedUntil: 0,
    callAboveAt: 0,
    pendingShot: 0,          // 0 none, 1 first shot, 2 second shot
    pendingRT: null,         // ms
    autoShotMode: true,      // auto assigns shot number from mic
    shotIndexThisTarget: 0,  // how many shots detected since last target was logged
    callTime: 0,             // perf.now() of call


  };
  
  function micUI(){
    const on = mic.enabled;
    $("micStopBtn").disabled = !on;
    $("micResetBtn").disabled = !on;
    $("micArmBtn").disabled = on;
  
    $("micStatus").textContent =
      !on ? "Off" :
      (mic.state === "WAIT_CALL") ? "Listening for CALL (ah/oh)..." :
      (mic.state === "WAIT_SHOT1") ? "Call detected ‚Äî waiting for SHOT 1..." :
      (mic.state === "WAIT_SHOT2") ? "Shot 1 detected ‚Äî waiting for SHOT 2 (optional)..." :
      "On";
  
    $("reactV").textContent = (mic.reactionMs == null) ? "‚Äî" : `${(mic.reactionMs/1000).toFixed(2)}s`;
    $("autoShotV").textContent = mic.enabled ? (mic.autoShot === 1 ? "1st" : "2nd") : "‚Äî";
  }
  
  function micResetCycle(){
    mic.state = "WAIT_CALL";
    mic.callTime = 0;
    mic.shot1Time = 0;
    mic.shot2Time = 0;
    mic.reactionMs = null;
    mic.autoShot = 1;
    mic.lastEventAt = 0;
    mic.shot1LockedUntil = 0;
    micUI();
  }
  
  async function micStart(){
    if(mic.enabled) return;
  
    try{
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }
      });
  
      const ctx = new (window.AudioContext || window.webkitAudioContext)();

      const src = ctx.createMediaStreamSource(stream);
      const analyser = ctx.createAnalyser();
      analyser.fftSize = 2048;
      
      // iOS quirk: keep graph ‚Äúalive‚Äù by connecting to destination with 0 gain
      const zero = ctx.createGain();
      zero.gain.value = 0;
      
      src.connect(analyser);
      analyser.connect(zero);
      zero.connect(ctx.destination);
      
      // iOS: explicitly resume audio context (must be in a user gesture)
      if (ctx.state === "suspended") {
        await ctx.resume();
      }
      
      // If still suspended, force-unlock with a tiny silent oscillator tick
      if (ctx.state === "suspended") {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        g.gain.value = 0;
        osc.connect(g);
        g.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.02);
        await ctx.resume().catch(()=>{});
      }
      
      mic.enabled = true;
      mic.stream = stream;
      mic.ctx = ctx;
      mic.src = src;
      mic.analyser = analyser;
      
      mic.baseline = 0;
      mic.smooth = 0;
      
      micResetCycle();
      micLoop();

    }catch(err){
      alert("Mic permission denied or not available.");
      console.error(err);
    }
  }
  
  function micStop(){
    if(!mic.enabled) return;
  
    cancelAnimationFrame(mic.raf);
    mic.raf = 0;
  
    try{ mic.stream && mic.stream.getTracks().forEach(t=>t.stop()); }catch{}
    try{ mic.ctx && mic.ctx.close(); }catch{}
  
    mic.enabled = false;
    mic.ctx = null;
    mic.stream = null;
    mic.src = null;
    mic.analyser = null;
  
    mic.state = "OFF";
    mic.reactionMs = null;
    mic.autoShot = 1;
  
    micUI();
  }
  
  function micRMS(){
    const a = mic.analyser;
    if(!a) return 0;
  
    const buf = new Uint8Array(a.fftSize);
    a.getByteTimeDomainData(buf);
  
    let sum = 0;
    for(let i=0;i<buf.length;i++){
      const v = (buf[i] - 128) / 128;
      sum += v*v;
    }
    return Math.sqrt(sum / buf.length);
  }
  
  function micLoop(){
    if(!mic.enabled) return;
  
    const now = performance.now();
    const rms = micRMS();
  
    // Smooth RMS (fast enough for shots, stable for voice)
    mic.smooth = mic.smooth * 0.85 + rms * 0.15;
  
    // Baseline (ambient) should update SLOWLY so voice stands out
    const cap = 0.12;
    const ambient = Math.min(mic.smooth, cap);
    mic.baseline = mic.baseline * 0.995 + ambient * 0.005;
  
    // Sensitivity: 0..100 => margin 0.035 .. 0.003 (higher sens = lower margin = more sensitive)
    const sens = Math.max(0, Math.min(100, Number($("micSens")?.value ?? 50)));
    const margin = 0.035 - (sens/100) * 0.032;
    const thresh = mic.baseline + Math.max(0.003, margin);
  
    // Current amplitude above baseline
    const amp = mic.smooth - mic.baseline;
  
    // Tunables for chest pocket
    const SHOT_AMP = 0.045;      // shot impulse amplitude
    const CALL_AMP = 0.005;      // voice amplitude
    const CALL_HOLD_MS = 120;    // voice must stay above CALL_AMP for this long
  
    // --- Impulse detector: shots ---
    const isImpulse = (amp >= SHOT_AMP) && (mic.smooth > thresh) && ((now - mic.lastEventAt) > 120);
  
    // --- Voice detector: sustained call ---
    if(!mic.callAboveAt && amp >= CALL_AMP && mic.smooth > thresh){
      mic.callAboveAt = now;
    }
    if(mic.callAboveAt && (amp < CALL_AMP || mic.smooth <= thresh)){
      mic.callAboveAt = 0;
    }
  
    const isVoiceHold =
      mic.callAboveAt &&
      ((now - mic.callAboveAt) >= CALL_HOLD_MS) &&
      ((now - mic.lastEventAt) > 250);
  
    if(isImpulse){
      micHandleShot(now);
      mic.lastEventAt = now;
      mic.callAboveAt = 0;
    } else if(isVoiceHold){
      micHandleCall(now);
      mic.lastEventAt = now;
      mic.callAboveAt = 0;
    }
  
    // Debug readout (safe even if micStatus doesn't exist)
    const ms = $("micStatus");
    if(ms){
      ms.textContent = `Level: ${(mic.smooth*1000).toFixed(1)} ‚Ä¢ Base: ${(mic.baseline*1000).toFixed(1)} ‚Ä¢ ${mic.state}`;
    }
  
    micUI();
    mic.raf = requestAnimationFrame(micLoop);
  }
  
  function micConsumePending(){
    const out = {
      shot: mic.pendingShot || 0,
      rtMs: (typeof mic.pendingRT === "number") ? mic.pendingRT : null
    };
    mic.pendingShot = 0;
    mic.pendingRT = null;
    return out;
  }
  
  function micResetForNextTarget(){
    // reset for next target call cycle
    mic.state = "WAIT_CALL";
    mic.callTime = 0;
    mic.shot1Time = 0;
    mic.shot2Time = 0;
    mic.shot1LockedUntil = 0;
    mic.callAboveAt = 0;
  
    // IMPORTANT: do NOT clear pending here (pushTarget already consumed it)
    micUI();
  }


  
  function micHandleCall(t){
    if(mic.state !== "WAIT_CALL") return;
  
    mic.callTime = t;
    mic.state = "WAIT_SHOT1";
  
    // clear any previous pending shot
    mic.pendingShot = 0;
    mic.pendingRT = null;
  
    mic.autoShot = 1;
  }
  
  function micHandleShot(t){
    if(t < mic.shot1LockedUntil) return;
  
    const win = Math.max(600, Math.min(2500, Number($("shot2Win")?.value || 1600)));
    if(!mic.callTime) return;
  
    // RT measured from CALL (works for both shots)
    const rt = Math.max(0, Math.round(t - mic.callTime));
  
    if(mic.state === "WAIT_SHOT1"){
      mic.shot1Time = t;
      mic.reactionMs = rt;
  
      // ‚úÖ store pending for the grid save
      mic.pendingShot = 1;
      mic.pendingRT = rt;
  
      mic.state = "WAIT_SHOT2";
      mic.autoShot = 1;
  
      mic.shot1LockedUntil = t + 220;
  
      setTimeout(()=>{
        if(mic.enabled && mic.state === "WAIT_SHOT2" && !mic.shot2Time){
          micResetCycle(); // back to WAIT_CALL if no 2nd shot
        }
      }, win);
  
      return;
    }
  
    if(mic.state === "WAIT_SHOT2"){
      if(mic.shot1Time && (t - mic.shot1Time) >= 180 && (t - mic.shot1Time) <= win){
        mic.shot2Time = t;
  
        // ‚úÖ overwrite pending (so if user taps after 2nd shot, it uses shot 2 RT)
        mic.pendingShot = 2;
        mic.pendingRT = rt;
  
        mic.autoShot = 2;
        mic.shot1LockedUntil = t + 220;
  
        setTimeout(()=>{
          if(mic.enabled) micResetCycle();
        }, 250);
      }
    }
  }

  function zoneClass(out, zone){
    if(out === "H"){
      return zone==="HL" ? "hitHL" :
             zone==="SL" ? "hitSL" :
             zone==="C"  ? "hitC"  :
             zone==="SR" ? "hitSR" : "hitHR";
    } else {
      return zone==="HL" ? "missHL" :
             zone==="SL" ? "missSL" :
             zone==="C"  ? "missC"  :
             zone==="SR" ? "missSR" : "missHR";
    }
  }

  function renderLive(){
    const idx = liveTargets.length;
    const {hit, shot2} = countsFromTargets(liveTargets);
  
    $("shotV").textContent = `${idx}/25`;
    $("scoreV").textContent = `${hit}/25`;
    $("hitPctV").textContent = `${pct(hit, Math.max(1, idx))}%`;
    $("shot2CountV").textContent = `${shot2}`;
  
    const lastShot = liveTargets[idx - 1]?.shot ?? 1;
  
    if(idx === 0) $("statusLine").textContent = "Ready.";
    else if(idx < 25) $("statusLine").textContent = `Live‚Ä¶ Target ${idx+1}/25 ‚Ä¢ Shot: ${lastShot === 1 ? "1st" : "2nd"}`;
    else $("statusLine").textContent = "Round complete. Save it or reset.";
  
    const done = idx >= 25;
    document.querySelectorAll(".zoneBtn").forEach(b => b.disabled = done);
    $("undoBtn").disabled = (idx === 0);
  
    const grid = $("shotGrid");
    grid.innerHTML = "";
    for(let i=0;i<25;i++){
      const t = liveTargets[i];
      const el = document.createElement("div");
  
      if(!t){
        el.className = "shot pending";
        el.innerHTML = `<div>‚Äî</div>`;
      } else {
        el.className = "shot";

        const isHit = (t.out === "H");
        const isSecondHit = isHit && (t.shot === 2);
        
        el.classList.add(
          isHit ? (isSecondHit ? "hit2" : "hit1") : "miss1"
        );
        
        const rtText = (typeof t.rtMs === "number") ? `${(t.rtMs/1000).toFixed(2)}s` : "‚Äî";
        
        el.innerHTML = `
          <div class="zoneTxt">${t.zone}</div>
          <div class="meta">${rtText}</div>
        `;

      }
      grid.appendChild(el);
    }
  }


  function pushTarget(out, zone, shotOverride){
    if(liveTargets.length >= 25) return;
  
    // pull pending mic info (if any)
    const pending = micConsumePending(); // {shot, rtMs}
  
    let shot = 1;
  
    // If mic auto-shot is ON and it detected 1st/2nd, it wins
    if(mic.autoShotMode && (pending.shot === 1 || pending.shot === 2)){
      shot = pending.shot;
    } else if(shotOverride === 1 || shotOverride === 2){
      // Otherwise use tap logic
      shot = shotOverride;
    } else {
      shot = 1;
    }
  
    liveTargets.push({
      out,
      zone,
      shot,
      rtMs: pending.rtMs
    });
  
    // ready for next target
    if(mic.enabled) micResetForNextTarget();
  
    renderLive();
  }


  // ---- Tap (1st) vs Double-tap (2nd) on zone buttons ----
  let tapTimer = null;
  let lastTapBtn = null;
  const DOUBLE_TAP_MS = 280;
  
  function clearTapTimer(){
    if(tapTimer){
      clearTimeout(tapTimer);
      tapTimer = null;
    }
    lastTapBtn = null;
  }
  
  document.querySelectorAll(".zoneBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(liveTargets.length >= 25) return;
  
      const out  = btn.getAttribute("data-out"); // "H" or "M"
      const zone = btn.getAttribute("data-zone");
  
      // ---- DOUBLE TAP (hit OR miss) ‚Üí always 2nd shot
      if(tapTimer && lastTapBtn === btn){
        clearTapTimer();
        pushTarget(out, zone, 2);
        return;
      }
  
      clearTapTimer();
      lastTapBtn = btn;
  
      tapTimer = setTimeout(()=>{
        tapTimer = null;
        lastTapBtn = null;
  
        // ---- SINGLE TAP LOGIC
        if(out === "M"){
          // ‚ùå Miss ‚Üí always 2nd shot
          pushTarget(out, zone, 2);
        } else {
          // ‚úÖ Hit ‚Üí 1st shot
          pushTarget(out, zone, 1);
        }
      }, DOUBLE_TAP_MS);
    });
  });

  
  $("undoBtn").addEventListener("click", ()=>{
    clearTapTimer();
    liveTargets.pop();
    renderLive();
  });
  
  // ---- Mic controls ----
  $("micArmBtn").addEventListener("click", async ()=>{
    await micStart();
    micUI();
  });
  
  $("micStopBtn").addEventListener("click", ()=>{
    micStop();
  });
  
  $("micResetBtn").addEventListener("click", ()=>{
    micResetCycle();
  });

  $("autoShotBtn").addEventListener("click", ()=>{
    mic.autoShotMode = !mic.autoShotMode;
    $("autoShotBtn").textContent = `Auto shot: ${mic.autoShotMode ? "ON" : "OFF"}`;
  });



  $("resetRoundBtn").addEventListener("click", ()=>{
    clearTapTimer();
    liveTargets = [];
    renderLive();
  });

  $("saveRoundBtn").addEventListener("click", ()=>{
    if(liveTargets.length !== 25){
      $("statusLine").textContent = `You are at ${liveTargets.length}/25. Finish the round to save.`;
      return;
    }
    const c = countsFromTargets(liveTargets);

    rounds.unshift({
      id: uid(),
      date: $("date").value || todayISO(),
      club: $("club").value.trim(),
      field: $("field").value.trim(),
      notes: $("notes").value,
      liveTargets: liveTargets.slice(),
      ...c,
      createdAt: Date.now()
    });

    save(rounds);

    liveTargets = [];
    $("notes").value = "";
    renderAll();
  });

  function unique(list){
    return Array.from(new Set(list.filter(Boolean)));
  }

  function rebuildDropdowns(){
    const clubs = unique(rounds.map(r => (r.club||"").trim())).sort((a,b)=>a.localeCompare(b));
    const fields = unique(rounds.map(r => (r.field||"").trim())).sort((a,b)=>a.localeCompare(b));

    const clubSel = $("clubSel");
    const fieldSel = $("fieldSel");
    const keepClub = clubSel.value || "all";
    const keepField = fieldSel.value || "all";

    clubSel.innerHTML = `<option value="all">All clubs</option>` + clubs.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    fieldSel.innerHTML = `<option value="all">All fields</option>` + fields.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");

    clubSel.value = clubs.includes(keepClub) ? keepClub : "all";
    fieldSel.value = fields.includes(keepField) ? keepField : "all";

    const savedClub = $("savedClub");
    const savedField = $("savedField");
    const keepSC = savedClub.value || "all";
    const keepSF = savedField.value || "all";

    savedClub.innerHTML = `<option value="all">All clubs</option>` + clubs.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    savedField.innerHTML = `<option value="all">All fields</option>` + fields.map(f=>`<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");

    savedClub.value = clubs.includes(keepSC) ? keepSC : "all";
    savedField.value = fields.includes(keepSF) ? keepSF : "all";

    const monthSel = $("monthSel");
    const monthKeys = unique(rounds.map(r => {
      const d = parseISODate(r.date);
      return d ? monthKey(d) : "";
    })).sort((a,b)=> (a>b ? -1 : 1));

    const keepMonth = monthSel.value || "";
    monthSel.innerHTML = `<option value="">Select month‚Ä¶</option>` + monthKeys.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join("");
    monthSel.value = monthKeys.includes(keepMonth) ? keepMonth : "";

    // üîπ Live Round club suggestions (typing + dropdown)
    const dl = $("clubList");
    if (dl) {
      dl.innerHTML = clubs
        .filter(Boolean)
        .map(c => `<option value="${escapeHtml(c)}"></option>`)
        .join("");
    }
  }

  function filterByMeta(list, clubVal, fieldVal){
    const c = clubVal || "all";
    const f = fieldVal || "all";
    return list.filter(r => {
      const okC = (c==="all") || ((r.club||"").trim() === c);
      const okF = (f==="all") || ((r.field||"").trim() === f);
      return okC && okF;
    });
  }

  function filterByRange(list){
    const now = new Date(); now.setHours(0,0,0,0);
    const range = $("rangeSel").value;
    const monthPick = $("monthSel").value;

    let start = null, end = null; // [start, end)
    if(range === "all"){
      start = null; end = null;
    } else if(range === "today"){
      start = new Date(now);
      end = new Date(now); end.setDate(end.getDate()+1);
    } else if(range === "week"){
      start = startOfWeek(now);
      end = new Date(start); end.setDate(end.getDate()+7);
    } else if(range === "month"){
      start = startOfMonth(now);
      end = addMonths(start, 1);
    } else if(range === "last3"){
      end = addMonths(startOfMonth(now), 1);
      start = addMonths(end, -3);
    } else if(range === "last6"){
      end = addMonths(startOfMonth(now), 1);
      start = addMonths(end, -6);
    } else if(range === "year"){
      start = startOfYear(now);
      end = new Date(now.getFullYear()+1, 0, 1);
    } else if(range === "monthPick"){
      if(!monthPick) return [];
      const [y,m] = monthPick.split("-").map(Number);
      start = new Date(y, m-1, 1); start.setHours(0,0,0,0);
      end = new Date(y, m, 1); end.setHours(0,0,0,0);
    }

    return list.filter(r=>{
      const d = parseISODate(r.date);
      if(!d) return false;
      if(!start && !end) return true;
      return (d >= start && d < end);
    });
  }

  function cartridgesFromRounds(list){
    return list.reduce((sum, r) => {
      const targets = Array.isArray(r.liveTargets) ? r.liveTargets : [];
  
      for (const t of targets) {
        if (!t) continue;
  
        // 1st shot = 1 cartridge
        // 2nd shot (hit OR miss) = 2 cartridges
        sum += (t.shot === 1) ? 1 : 2;
      }
  
      return sum;
    }, 0);
  }


  
  function renderCartridgesSection(){
    const auto = cartridgesFromRounds(rounds);
    const manual = loadCartridgeManual();
    $("cartridgeTotal").textContent = auto + manual;
  }



  function tier(score){
    if(score >= 20) return "good";
    if(score >= 18) return "mid";
    return "low";
  }

  function zoneReadable(z){
    return z==="HL" ? "Hard Left" :
           z==="SL" ? "Soft Left" :
           z==="C"  ? "Center" :
           z==="SR" ? "Soft Right" : "Hard Right";
  }

  function insightTextForZone(z){
    if(z==="C")  return "Timing + trigger discipline on straight birds";
    if(z==="SL") return "Clean start line, smooth acceleration (soft-left)";
    if(z==="HL") return "Earlier pick-up + commit through hard-left";
    if(z==="SR") return "Keep the gun moving (soft-right), no checking";
    if(z==="HR") return "Don‚Äôt stop the barrel on hard-right ‚Äî drive through";
    return "Work your weakest zone first";
  }
  function renderScoreTrend(list){
    // Show chronological trend by ROUND DATE
    const data = list.slice().sort((a,b)=>{
      const da = parseISODate(a.date); const db = parseISODate(b.date);
      const ta = da ? da.getTime() : 0;
      const tb = db ? db.getTime() : 0;
      if(ta !== tb) return ta - tb; // oldest -> newest
      return (a.createdAt||0) - (b.createdAt||0);
    });
  
    const sub = $("scoreTrendSub");
    const pathEl = $("scoreTrendPath");
    const dotsEl = $("scoreTrendDots");
    const gridEl = $("scoreTrendGrid");
    const yLabEl = $("scoreTrendYLabels");

  
    if(!data.length){
      sub.textContent = "No rounds in this period.";
      pathEl.setAttribute("d", "");
      dotsEl.innerHTML = "";
      gridEl.innerHTML = "";
      yLabEl.innerHTML = "";
      return;
    }
    
    const allScores = data.map(r => (r.hit || 0));
    const minScore = Math.min(...allScores);
    const maxScore = Math.max(...allScores);
  
    // Use at most 40 points so it stays readable
    const maxPts = 40;
    const step = Math.ceil(data.length / maxPts);
    const pts = data.filter((_,i)=> i % step === 0);
  
    // SVG chart area
    const W = 360, H = 140;
    const left = 30, right = 350, top = 10, bottom = 120;
    const plotW = right - left;
    const plotH = bottom - top;
  
    const n = pts.length;
    const xAt = (i)=> left + (n===1 ? plotW/2 : (i/(n-1))*plotW);
  
    // y maps score 10..25 to bottom..top
    const yAtScore = (score)=>{
      const s = Math.max(15, Math.min(25, score||15));
      return bottom - ((s - 15) / 10) * plotH; // 10 = (25-15)
    };
  
    const coords = pts.map((r,i)=>({
      x: xAt(i),
      y: yAtScore(r.hit||0),
      v: (r.hit||0),
      d: (r.date||"")
    }));
    
    // Gridlines every 1 point from 15 to 25
    let gridHtml = "";
    for(let s=15; s<=25; s++){
      const y = yAtScore(s);
    
      // Make 5-point lines a bit stronger (15,20,25)
      const strong = (s % 5 === 0);
      const op = strong ? 0.55 : 0.18;
      const w  = strong ? 1.2 : 0.8;
    
      gridHtml += `<path d="M${left} ${y} H${right}" fill="none" stroke="var(--border)" stroke-width="${w}" opacity="${op}"/>`;
    }
    gridEl.innerHTML = gridHtml;
   
    // Y-axis labels only at 15/20/25
    yLabEl.innerHTML = [15,20,25].map(s=>{
      const y = yAtScore(s) + 3;
      return `<text x="6" y="${y}" fill="var(--muted)" font-size="10" font-weight="900">${s}</text>`;
    }).join("");

    // Build smooth-ish polyline using quadratic curves
    let d = "";
    if(coords.length === 1){
      d = `M ${coords[0].x} ${coords[0].y}`;
    } else {
      d = `M ${coords[0].x} ${coords[0].y}`;
      for(let i=1;i<coords.length;i++){
        const prev = coords[i-1];
        const cur = coords[i];
        const mx = (prev.x + cur.x) / 2;
        const my = (prev.y + cur.y) / 2;
        d += ` Q ${prev.x} ${prev.y} ${mx} ${my}`;
        if(i === coords.length-1){
          d += ` T ${cur.x} ${cur.y}`;
        }
      }
    }
  
    pathEl.setAttribute("d", d);
  
    // Dots (red <15, orange 15‚Äì19, green ‚â•20)
    dotsEl.innerHTML = coords.map(p=>{
      let color;
    
      if(p.v < 15){
        color = "var(--r1)";        // red
      } else if(p.v <= 19){
        color = "var(--orange)";   // orange
      } else {
        color = "var(--g1)";       // green
      }
    
      return `
        <circle
          cx="${p.x}"
          cy="${p.y}"
          r="3.5"
          fill="${color}"
        >
          <title>${p.d}: ${p.v}/25</title>
        </circle>
      `;
    }).join("");

  
    // Subtitle
    const first = coords[0], last = coords[coords.length-1];
    sub.textContent = `${data.length} rounds ‚Ä¢ ${first.d || "‚Äî"} ‚Üí ${last.d || "‚Äî"} ‚Ä¢ Min ${minScore}/25 ‚Ä¢ Max ${maxScore}/25`;
  }

  function renderOverview(){
    const isMonthPick = $("rangeSel").value === "monthPick";
    $("monthSel").disabled = !isMonthPick;

    let list = rounds.slice();
    list = filterByMeta(list, $("clubSel").value, $("fieldSel").value);
    list = filterByRange(list);

    $("rangeCount").textContent = `${list.length} rounds`;

    // Reset if empty
    if(list.length === 0){
      $("avgHits").textContent = "0.0/25";
      $("avgHitsSub").textContent = "Avg hit %: 0%";
      $("bestWorst").textContent = "‚Äî";
      $("last10").textContent = "‚Äî";
      $("last10Sub").textContent = "Avg hits (if ‚â•10)";
      $("avgMHL").textContent = "0.0";
      $("avgMSL").textContent = "0.0";
      $("avgMC").textContent  = "0.0";
      $("avgMSR").textContent = "0.0";
      $("avgMHR").textContent = "0.0";
      $("missDiagramSub").textContent = "Based on selected period";
      $("mostMissedBadge").style.display = "none";
      $("insightBadge").style.display = "none";
      $("avgShot2").textContent = "0.0/25";
      $("avgDirL").textContent = "0.0";
      $("avgDirC").textContent = "0.0";
      $("avgDirR").textContent = "0.0";
      
      renderScoreTrend([]);
      return;
    }

    const totalHit = list.reduce((s,r)=>s+(r.hit||0),0);
    const avgHits = totalHit / list.length;
    const avgPct = pct(totalHit, list.length*25);

    const scores = list.map(r=> (r.hit||0));
    const best = Math.max(...scores);
    const worst = Math.min(...scores);

    // Last 10 rounds: IGNORE the selected period. Use ALL rounds.
    const allByRecent = rounds.slice().sort((a,b)=>{
      const da = parseISODate(a.date); const db = parseISODate(b.date);
      const ta = da ? da.getTime() : 0;
      const tb = db ? db.getTime() : 0;
    
      // newest round date first
      if(tb !== ta) return tb - ta;
    
      // tie-breaker: newest saved first
      return (b.createdAt||0) - (a.createdAt||0);
    });
    
    const last10List = allByRecent.slice(0,10);
    const last10Avg = last10List.length
      ? (last10List.reduce((s,r)=>s+(r.hit||0),0) / last10List.length)
      : null;


    // Miss totals per zone (from saved counts)
    const missTotals = {HL:0, SL:0, C:0, SR:0, HR:0};
    for(const r of list){
      const mz = r.missZone || {};
      for(const z of ZONES) missTotals[z] += (mz[z] || 0);
    }

    // Determine most missed zone
    const missSorted = ZONES.map(z=>({z, v: missTotals[z]})).sort((a,b)=>b.v-a.v);
    const topMiss = missSorted[0];

    $("avgHits").textContent = `${avgHits.toFixed(1)}/25`;
    $("avgHitsSub").textContent = `Avg hit %: ${avgPct}%`;

    const bestStar = best >= 23 ? " ‚≠ê" : "";
    $("bestWorst").innerHTML = `
      <span class="pillScore ${tier(best)}">Best: ${best}/25${bestStar}</span>
      <span class="pillScore ${tier(worst)}">Worst: ${worst}/25</span>
    `;

    if(last10List.length >= 10){
      $("last10").textContent = `${last10Avg.toFixed(1)}/25`;
      $("last10Sub").textContent = `Average of last 10 rounds`;
    } else {
      $("last10").textContent = "‚Äî";
      $("last10Sub").textContent = `Need 10 rounds (you have ${last10List.length})`;
    }
    // Avg reliance on 2nd shot (per round)
    const totalShot2 = list.reduce((s,r)=>s+(r.shot2||0),0);
    const avgShot2 = totalShot2 / list.length;
    
    $("avgShot2").textContent = `${avgShot2.toFixed(1)}/25`;
    $("avgShot2Sub").textContent = "Avg per round (selected period)";

    // Avg misses per round by zone (5)
    const avgM = {
      HL: missTotals.HL / list.length,
      SL: missTotals.SL / list.length,
      C:  missTotals.C  / list.length,
      SR: missTotals.SR / list.length,
      HR: missTotals.HR / list.length
    };

    $("avgMHL").textContent = avgM.HL.toFixed(1);
    $("avgMSL").textContent = avgM.SL.toFixed(1);
    $("avgMC").textContent  = avgM.C.toFixed(1);
    $("avgMSR").textContent = avgM.SR.toFixed(1);
    $("avgMHR").textContent = avgM.HR.toFixed(1);
    // Avg misses per round by direction (LEFT = HL+SL, CENTER = C, RIGHT = SR+HR)
    const avgDirL = (missTotals.HL + missTotals.SL) / list.length;
    const avgDirC = (missTotals.C) / list.length;
    const avgDirR = (missTotals.SR + missTotals.HR) / list.length;
    
    $("avgDirL").textContent = avgDirL.toFixed(1);
    $("avgDirC").textContent = avgDirC.toFixed(1);
    $("avgDirR").textContent = avgDirR.toFixed(1);

    $("missDiagramSub").textContent = `Avg misses per round (selected period)`;

    // --- Reaction time stats (selected period) ---
    const rt1 = [];
    const rt2 = [];
    
    for(const r of list){
      const tarr = Array.isArray(r.liveTargets) ? r.liveTargets : [];
      for(const t of tarr){
        if(!t || typeof t.rtMs !== "number") continue;
        if(t.shot === 1) rt1.push(t.rtMs);
        if(t.shot === 2) rt2.push(t.rtMs);
      }
    }
    
    const m1 = mean(rt1), s1 = std(rt1);
    const m2 = mean(rt2), s2 = std(rt2);
    
    $("avgRT1").textContent = m1 === null ? "‚Äî" : fmtSec(m1);
    $("avgRT2").textContent = m2 === null ? "‚Äî" : fmtSec(m2);
    
    // Consistency = SD (lower is better). Also show count.
    $("rt1Sub").textContent =
      (s1 === null ? "Consistency: ‚Äî" : `Consistency (SD): ${fmtSec(s1)}`) +
      ` ‚Ä¢ n=${rt1.length}`;
    
    $("rt2Sub").textContent =
      (s2 === null ? "Consistency: ‚Äî" : `Consistency (SD): ${fmtSec(s2)}`) +
      ` ‚Ä¢ n=${rt2.length}`;


    // Badges
    const badge = $("mostMissedBadge");
    badge.style.display = "inline-flex";
    badge.className = `badge z${topMiss.z}`;
    badge.innerHTML = `<span class="dot" style="background:var(--r1)"></span> Most missed: <strong>${topMiss.z}</strong> (${topMiss.v})`;

    const insight = $("insightBadge");
    insight.style.display = "inline-flex";
    insight.className = "badge";
    insight.innerHTML = `üéØ ${insightTextForZone(topMiss.z)}`;

    const r = $("rangeSel").value;
    const label =
      r==="today" ? "Today" :
      r==="week" ? "This week" :
      r==="month" ? "This month" :
      r==="last3" ? "Last 3 months" :
      r==="last6" ? "Last 6 months" :
      r==="year" ? "This year" :
      r==="all" ? "All time" :
      r==="monthPick" ? ( $("monthSel").value ? monthLabel($("monthSel").value) : "Past month" ) :
      "Selected period";
    $("overviewSubtitle").textContent = `Stats for: ${label}`;
    renderScoreTrend(list);
  }
  
  function renderSaved(){
    let list = getSavedFilteredList();

    $("countLine").textContent = `${rounds.length} total ‚Ä¢ ${list.length} shown`;

    const container = $("list");
    container.innerHTML = "";
    $("empty").style.display = list.length ? "none" : "block";

    for(const r of list){
      const targetsArr = Array.isArray(r.liveTargets) ? r.liveTargets : [];
      const missCount = (r.miss || 0);

      // Compact preview (25 icons)
      const preview = targetsArr.slice(0,25).map((t)=>{
        if(!t) return `<span style="
          display:inline-flex;align-items:center;justify-content:center;
          width:22px;height:22px;border-radius:8px;border:1px solid var(--border);
          margin:2px;font-weight:950;font-size:12px;color:var(--muted)
        ">¬∑</span>`;

        const isHit = t.out === "H";
        const bg = isHit ? "rgba(34,197,94,.10)" : "rgba(239,68,68,.10)";
        const bd = isHit ? "rgba(34,197,94,.25)" : "rgba(239,68,68,.22)";
        const col = isHit ? "var(--g1)" : "var(--r1)";
        const txt = (isHit ? "‚úì" : "√ó") + t.zone; // e.g. ‚úìC, √óHL

        return `<span title="${isHit?"Hit":"Miss"} ${zoneReadable(t.zone)} ‚Ä¢ Shot ${t.shot}" style="
          display:inline-flex;align-items:center;justify-content:center;
          width:32px;height:22px;border-radius:8px;border:1px solid ${bd};
          background:${bg};
          margin:2px;
          font-weight:950;font-size:11px;
          color:${col};
          letter-spacing:.2px;
        ">${txt}</span>`;
      }).join("");

      const club = (r.club||"").trim();
      const field = (r.field||"").trim();
      const place = [club, field].filter(Boolean).join(" ‚Ä¢ ");

      const el = document.createElement("div");
      el.className = "round";
      el.innerHTML = `
        <div class="roundHead">
          <div>
            <div style="font-weight:950">${r.date || ""} <span class="meta2">${place ? "‚Ä¢ "+escapeHtml(place) : ""}</span></div>
            <div class="meta2">
              Score: <b>${r.hit}/25</b> ‚Ä¢ 1st Shot: ${r.shot1||0} ‚Ä¢ 2nd Shot: ${r.shot2||0}
            </div>
          </div>
          <button class="btn danger" data-del="${r.id}">Delete</button>
        </div>

        <div style="padding:10px 12px;border-bottom:1px solid var(--border)">
          <div class="small" style="margin-bottom:6px">Pattern</div>
          <div style="display:flex;flex-wrap:wrap;gap:0">
            ${preview || "<span class='small'>No pattern saved.</span>"}
          </div>
        </div>
        
        <div class="mini">
          <div class="box g"><div class="k">Hit</div><div class="v" style="color:var(--g1)">${r.hit||0}</div></div>
          <div class="box rr"><div class="k">Miss</div><div class="v" style="color:var(--r1)">${r.miss||0}</div></div>
          <div class="box oo"><div class="k">1st Shot</div><div class="v" style="color:var(--orange)">${r.shot1||0}</div></div>
          <div class="box yy"><div class="k">2nd Shot</div><div class="v" style="color:var(--yellow)">${r.shot2||0}</div></div>
        </div>

        <div style="padding:12px;border-top:1px solid var(--border)">
          <div class="small" style="margin-bottom:8px">Misses by zone</div>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <span class="badge zHL">HL: <strong>${(r.missZone && r.missZone.HL) ? r.missZone.HL : 0}</strong></span>
            <span class="badge zSL">SL: <strong>${(r.missZone && r.missZone.SL) ? r.missZone.SL : 0}</strong></span>
            <span class="badge zC">C: <strong>${(r.missZone && r.missZone.C) ? r.missZone.C : 0}</strong></span>
            <span class="badge zSR">SR: <strong>${(r.missZone && r.missZone.SR) ? r.missZone.SR : 0}</strong></span>
            <span class="badge zHR">HR: <strong>${(r.missZone && r.missZone.HR) ? r.missZone.HR : 0}</strong></span>
          </div>
        </div>

        <div class="notes">${r.notes ? escapeHtml(r.notes) : "<span class='meta2'>No notes.</span>"}</div>
      `;
      container.appendChild(el);
    }

    // wire deletes
    container.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        rounds = rounds.filter(r=>r.id!==id);
        save(rounds);
        renderAll();
      });
    });
  }
 function getSavedFilteredList(){
    let list = rounds.slice();
  
    const mode = $("savedRange").value;
    const today = todayISO();
  
    // enable/disable date picker
    $("savedDate").disabled = (mode !== "day");
  
    // Build [start, end) date bounds (same logic as overview)
    const now = new Date(); now.setHours(0,0,0,0);
    let start = null, end = null;
  
    if(mode === "all"){
      start = null; end = null;
    } else if(mode === "today"){
      start = new Date(now);
      end = new Date(now); end.setDate(end.getDate()+1);
    } else if(mode === "week"){
      start = startOfWeek(now);
      end = new Date(start); end.setDate(end.getDate()+7);
    } else if(mode === "month"){
      start = startOfMonth(now);
      end = addMonths(start, 1);
    } else if(mode === "last3"){
      end = addMonths(startOfMonth(now), 1);
      start = addMonths(end, -3);
    } else if(mode === "last6"){
      end = addMonths(startOfMonth(now), 1);
      start = addMonths(end, -6);
    } else if(mode === "year"){
      start = startOfYear(now);
      end = new Date(now.getFullYear()+1, 0, 1);
      end.setHours(0,0,0,0);
    } else if(mode === "day"){
      const picked = $("savedDate").value || today;
      start = parseISODate(picked);
      end = parseISODate(picked);
      if(end) end.setDate(end.getDate()+1);
    }
  
    // Apply date range
    list = list.filter(r=>{
      const d = parseISODate(r.date);
      if(!d) return false;
      if(!start && !end) return true;
      return (d >= start && d < end);
    });
  
    // Club + Field filters
    list = filterByMeta(list, $("savedClub").value, $("savedField").value);
  
    // Sort newest first
    list.sort((a,b)=>{
      const da = parseISODate(a.date);
      const db = parseISODate(b.date);
    
      const ta = da ? da.getTime() : 0;
      const tb = db ? db.getTime() : 0;
    
      // newest round date first
      if(tb !== ta) return tb - ta;
    
      // tie-breaker: newest saved first
      return (b.createdAt||0) - (a.createdAt||0);
    });
    return list;
  }


function exportSavedRoundsPDF(){
  const exportList = getSavedFilteredList();

  const mode = $("savedRange").value;
  const dateLabel =
    mode === "today" ? `Today (${todayISO()})` :
    mode === "day" ? `Day (${ $("savedDate").value || todayISO() })` :
    "All rounds";

  const clubLabel = $("savedClub").value === "all" ? "All clubs" : $("savedClub").value;
  const fieldLabel = $("savedField").value === "all" ? "All fields" : $("savedField").value;

  const profileName =
    (activeProfile && activeProfile.name)
      ? activeProfile.name
      : ((loadProfiles().find(p => p.id === getActiveProfileId()) || {}).name || "Unknown");
  
  const title = `Olympic TrapPerformance ‚Äî ${profileName}`;
  const subtitle = `Filters: ${dateLabel} ‚Ä¢ ${clubLabel} ‚Ä¢ ${fieldLabel} ‚Ä¢ Exported: ${new Date().toLocaleString()}`;


  // ---- helpers (PDF-only) ----
  const fmt1 = (n)=> (Math.round(n*10)/10).toFixed(1);

  function tier(score){
    if(score >= 20) return "good";
    if(score >= 18) return "mid";
    return "low";
  }

  function computeExportStats(list){
    if(!list.length){
      return { avgHits:0, avgPct:0, best:0, worst:0, avgShot2:0, avgDirL:0, avgDirC:0, avgDirR:0 };
    }
  
    const totalHit = list.reduce((s,r)=>s+(r.hit||0),0);
    const avgHits = totalHit / list.length;
    const avgPct = pct(totalHit, list.length*25);
  
    const scores = list.map(r=> (r.hit||0));
    const best = Math.max(...scores);
    const worst = Math.min(...scores);
  
    const totalShot2 = list.reduce((s,r)=>s+(r.shot2||0),0);
    const avgShot2 = totalShot2 / list.length;
  
    // Miss direction totals from missZone
    const missTotals = {HL:0, SL:0, C:0, SR:0, HR:0};
    for(const r of list){
      const mz = r.missZone || {};
      missTotals.HL += (mz.HL || 0);
      missTotals.SL += (mz.SL || 0);
      missTotals.C  += (mz.C  || 0);
      missTotals.SR += (mz.SR || 0);
      missTotals.HR += (mz.HR || 0);
    }
  
    const avgDirL = (missTotals.HL + missTotals.SL) / list.length;
    const avgDirC = (missTotals.C) / list.length;
    const avgDirR = (missTotals.SR + missTotals.HR) / list.length;
  
    return { avgHits, avgPct, best, worst, avgShot2, avgDirL, avgDirC, avgDirR };
  }


  function zoneChar(z){
    if(z==="HL") return "L";
    if(z==="SL") return "l";
    if(z==="C")  return "c";
    if(z==="SR") return "r";
    if(z==="HR") return "R";
    return "¬∑";
  }

  // 5 groups of 5 targets, each cell shows ‚úì/√ó with direction under it
  function patternHtml(targetsArr){
    const arr = (Array.isArray(targetsArr) ? targetsArr : []).slice(0,25);

    let html = `<div class="patRow">`;
    for(let g=0; g<5; g++){
      html += `<div class="patGroup">`;
      for(let i=0; i<5; i++){
        const t = arr[g*5 + i];
        const isHit = !!(t && t.out === "H");
        const sym = isHit ? "‚úì" : "√ó";
        const dir = t ? zoneChar(t.zone) : "¬∑";

        html += `
          <span class="patCell ${isHit ? "hit" : "miss"}">
            <span class="sym">${sym}</span>
            <span class="dir">${dir}</span>
          </span>`;
      }
      html += `</div>`;
    }
    html += `</div>`;
    return html;
  }

  const stats = computeExportStats(exportList);

  // One top stats block (like app) for the exported/filtered list
  const topStatsHtml = `
    <div class="topStats">
      <div class="tsBox">
        <div class="k">Average</div>
        <div class="v">${fmt1(stats.avgHits)}/25</div>
        <div class="s">Avg hit %: ${stats.avgPct}%</div>
      </div>

      <div class="tsBox">
        <div class="k">Best / Worst</div>
        <div class="v">
          ${stats.best}/25<br>
          ${stats.worst}/25
        </div>
      </div>


      <div class="tsBox">
        <div class="k">Avg misses</div>
        <div class="v">${fmt1(stats.avgDirL)}L / ${fmt1(stats.avgDirC)}C / ${fmt1(stats.avgDirR)}R</div>
      </div>


      <div class="tsBox">
        <div class="k">2nd Shot reliance</div>
        <div class="v">${fmt1(stats.avgShot2)}/25</div>
        <div class="s">Avg per round</div>
      </div>
    </div>
  `;

  // Build printable HTML rows
  const rowsHtml = exportList.map((r) => {
    const club = (r.club||"").trim();
    const field = (r.field||"").trim();
    const place = [club, field].filter(Boolean).join(" ‚Ä¢ ");

    const missZone = r.missZone || {};
    const mz = (z)=> (missZone[z]||0);

    const notes = (r.notes||"").trim();
    const pat = patternHtml(r.liveTargets || []);

    return `
      <div class="card">
        <div class="head">
          <div>
            <div class="date">
              ${escapeHtml(r.date||"")}
              <span class="meta">
                ‚Ä¢ ${escapeHtml(place)}
              </span>
            </div>
          </div>
          <div class="score">${r.hit || 0}/25</div>
        </div>

        <div class="line">
          1st Shot: <b>${r.shot1||0}</b> ‚Ä¢
          2nd Shot: <b>${r.shot2||0}</b> &nbsp;&nbsp;|&nbsp;&nbsp;
          HL:${mz("HL")} SL:${mz("SL")} C:${mz("C")} SR:${mz("SR")} HR:${mz("HR")}
        </div>


        <div class="pattern">
          ${pat}
        </div>

        ${notes ? `<div class="notes"><b>Notes:</b> ${escapeHtml(notes)}</div>` : ``}
      </div>
    `;
  }).join("");

  const printHtml = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${escapeHtml(title)}</title>
  <style>
    /* Print-friendly (light) */
    body{ font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; margin:24px; color:#111; }
    .title{ font-size:18px; font-weight:900; margin:0 0 6px; }
    .sub{ color:#444; font-size:12px; margin:0 0 10px; }
    .count{ font-size:12px; color:#333; margin:0 0 14px; }

    .topStats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin:10px 0 14px;
    }
    .tsBox{
      border:1px solid #d7d7d7;
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    .tsBox .k{ font-size:11px; color:#666; font-weight:800; }
    .tsBox .v{ font-size:18px; font-weight:950; margin-top:3px; }
    .tsBox .s{ font-size:11px; color:#666; margin-top:4px; }

    .tsBox.yellow{
      background: rgba(234,179,8,.12);
      border-color: rgba(234,179,8,.55);
    }

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #bbb;
      font-weight:900;
      margin-right:6px;
      font-size:12px;
      white-space:nowrap;
    }
    .pill.good{ border-color: rgba(34,197,94,.7); }
    .pill.mid{  border-color: rgba(249,115,22,.7); }
    .pill.low{  border-color: rgba(239,68,68,.7); }

    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:12px;
      margin:0 0 10px;
      break-inside: avoid;
    }
    .head{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .date{ font-size:14px; font-weight:900; }
    .meta{ font-size:12px; color:#444; margin-top:2px; }
    .score{ font-size:16px; font-weight:900; }

    .line{ font-size:12px; margin-top:6px; color:#222; }
    .zones{ display:flex; flex-wrap:wrap; gap:10px; font-size:12px; margin-top:8px; color:#222; }

    .pattern{ font-size:11px; margin-top:6px; color:#222; }
    .notes{ font-size:11px; margin-top:8px; color:#222; }

    /* Pattern layout: 5 groups of 5, direction under ‚úì/√ó, one line */
    .patRow{
      display:flex;
      gap:16px;          /* spacing between each 5-target group */
      flex-wrap:nowrap;  /* keep in one line */
      align-items:flex-end;
      margin-top:6px;
    }
    .patGroup{
      display:inline-flex;
      gap:0px;           /* spacing between targets in a group */
    }
    .patCell{
      width:18px;
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      line-height:1;
      font-weight:950;
    }
    .patCell .sym{ font-size:13px; line-height:1; }
    .patCell .dir{ font-size:9px; line-height:1; margin-top:1px; color:#444; }

    .patCell.hit .sym{ color:#16a34a; }   /* green */
    .patCell.miss .sym{ color:#dc2626; }  /* red */

    @media print{
      body{ margin:12mm; }
      .card{ border-color:#bbb; }
      /* keep colors in PDF */
      *{ -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }
  </style>
</head>
<body>
  <div class="title">${escapeHtml(title)}</div>
  <div class="sub">${escapeHtml(subtitle)}</div>

  ${topStatsHtml}

  <div class="count">${exportList.length} round(s)</div>

  ${rowsHtml || `<div>No rounds match these filters.</div>`}

  <script>
    window.onload = () => window.print();
  <\/script>
</body>
</html>`;

  const w = window.open("", "_blank");
  if(!w){
    alert("Popup blocked. Please allow popups to export PDF.");
    return;
  }
  w.document.open();
  w.document.write(printHtml);
  w.document.close();
}

// Button handler
$("exportPdfBtn").addEventListener("click", exportSavedRoundsPDF);

  const plusBtn = $("cartridgePlus");
  const minusBtn = $("cartridgeMinus");
  const stepInp = $("cartridgeStep");
  
  if (plusBtn && minusBtn && stepInp) {
    plusBtn.addEventListener("click", () => {
      const step = Math.max(1, Math.floor(Number(stepInp.value || 25)));
      saveCartridgeManual(loadCartridgeManual() + step);
      renderCartridgesSection();
    });
  
    minusBtn.addEventListener("click", () => {
      const step = Math.max(1, Math.floor(Number(stepInp.value || 25)));
      saveCartridgeManual(Math.max(0, loadCartridgeManual() - step));
      renderCartridgesSection();
    });
  }

  /* =========================
   COMPETITION MODE (Scores only)
   Olympic Trap only
   ========================= */

  function loadCompetitions(){
    try{
      const raw = localStorage.getItem(COMP_KEY);
      const list = raw ? JSON.parse(raw) : [];
      return Array.isArray(list) ? list : [];
    }catch{ return []; }
  }
  function saveCompetitions(list){
    localStorage.setItem(COMP_KEY, JSON.stringify(list));
  }
  function compThemeGet(){
    return "blue";
  }

  function compThemeSet(v){
    localStorage.setItem(COMP_THEME_KEY, v === "red" ? "red" : "blue");
  }
  
  let competitions = [];          // loaded per profile
  let editingCompId = null;       // null = new, otherwise edit existing
  
  
  function applyCompThemeToCards(){
    const t = compThemeGet();
    // apply on the whole comp page for consistent accent
    const panel = $("panelComp");
    if(panel){
      panel.classList.toggle("compThemeBlue", t === "blue");
      panel.classList.toggle("compThemeRed", t === "red");
    }

  
    // also apply to accent cards
    ["compControlsCard","compFormCard"].forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.classList.toggle("compThemeBlue", t === "blue");
      el.classList.toggle("compThemeRed", t === "red");
    });
  }
  
  function sumRounds(rounds){
    const arr = Array.isArray(rounds) ? rounds : [];
    let sum = 0;
    let filled = 0;
    for(const v of arr){
      if(v === null || v === undefined || v === "") continue;
      const n = Number(v);
      if(Number.isFinite(n)){
        sum += n;
        filled++;
      }
    }
    return {sum, filled};
  }
  
  function ensureRoundsArray(count, existing){
    const n = Math.max(1, Math.min(10, Math.floor(Number(count || 5))));
    const arr = Array.isArray(existing) ? existing.slice(0, n) : [];
    while(arr.length < n) arr.push(null);
    return arr;
  }
  
  function openCompForm(comp){
    $("compFormCard").style.display = "block";
    $("compControlsCard").scrollIntoView({behavior:"smooth", block:"start"});
    editingCompId = comp ? comp.id : null;
  
    $("compFormTitle").textContent = comp ? "Edit competition" : "New competition";
    $("compName").value = comp ? (comp.name || "") : "";
    $("compDate").value = comp ? (comp.date || todayISO()) : todayISO();
    $("compClub").value = comp ? (comp.club || "") : "";
    $("compNotes").value = comp ? (comp.notes || "") : "";
  
    const roundsCount = comp ? (comp.roundsCount || 5) : 5;
    $("compRoundsCount").value = String(roundsCount);
  
    const finalPlayed = comp && comp.finalPlayed ? "yes" : "no";
    $("compFinalPlayed").value = finalPlayed;
  
    const showFinal = finalPlayed === "yes";
    $("finalScoreWrap").style.display = showFinal ? "block" : "none";
    $("compFinalScore").value = showFinal ? String(comp.finalScore ?? "") : "";
  
    // build round inputs
    const rounds = ensureRoundsArray(roundsCount, comp ? comp.rounds : null);
    buildCompRoundInputs(rounds);
    updateCompTotalsLine();
  }
  
  function closeCompForm(){
    $("compFormCard").style.display = "none";
    editingCompId = null;
  }
  
  function buildCompRoundInputs(rounds){
    const holder = $("compRoundInputs");
    holder.innerHTML = "";
    const arr = ensureRoundsArray($("compRoundsCount").value, rounds);
  
    arr.forEach((val, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "ri";
  
      const lab = document.createElement("label");
      lab.textContent = `R${idx+1}`;
      wrap.appendChild(lab);
  
      const inp = document.createElement("input");
      inp.type = "number";
      inp.min = "0";
      inp.max = "25";
      inp.inputMode = "numeric";
      inp.placeholder = "‚Äî";
      inp.value = (val === null || val === undefined) ? "" : String(val);
  
      inp.addEventListener("input", ()=>{
        // allow blank
        const raw = inp.value.trim();
        if(raw === ""){
          inp.dataset.val = "";
        }else{
          let n = Math.floor(Number(raw));
          if(!Number.isFinite(n)) n = 0;
          n = Math.max(0, Math.min(25, n));
          inp.value = String(n);
          inp.dataset.val = String(n);
        }
        updateCompTotalsLine();
      });
  
      wrap.appendChild(inp);
      holder.appendChild(wrap);
    });
  }
  
  function readCompRoundsFromInputs(){
    const inputs = $("compRoundInputs").querySelectorAll("input[type='number']");
    const arr = [];
    inputs.forEach(inp=>{
      const raw = (inp.value || "").trim();
      if(raw === "") arr.push(null);
      else{
        let n = Math.floor(Number(raw));
        if(!Number.isFinite(n)) n = 0;
        n = Math.max(0, Math.min(25, n));
        arr.push(n);
      }
    });
    return arr;
  }
  
  function updateCompTotalsLine(){
    const rounds = readCompRoundsFromInputs();
    const {sum, filled} = sumRounds(rounds);
    const count = rounds.length;
    $("compTotalsLine").textContent = `Total: ${sum} ‚Ä¢ Rounds filled: ${filled}/${count}`;
  }
  
  function renderCompList(){
    competitions = loadCompetitions();
  
    const list = competitions.slice().sort((a,b)=>{
      const da = parseISODate(a.date || "");
      const db = parseISODate(b.date || "");
      const ta = da ? da.getTime() : 0;
      const tb = db ? db.getTime() : 0;
      if(tb !== ta) return tb - ta;
      return (b.createdAt||0) - (a.createdAt||0);
    });
  
    $("compCountLine").textContent = `${list.length} total`;
  
    const holder = $("compList");
    holder.innerHTML = "";
    $("compEmpty").style.display = list.length ? "none" : "block";
  
    for(const c of list){
      const roundsCount = Number(c.roundsCount || 5);
      const roundsArr = ensureRoundsArray(roundsCount, c.rounds);
      const { sum } = sumRounds(roundsArr);
  
      const roundsLine = roundsArr
        .map(v => (Number.isFinite(v) ? String(v) : "‚Äî"))
        .join(" ‚Ä¢ ");
  
      const finalPlayed = !!c.finalPlayed;
      const finalVal = finalPlayed ? (c.finalScore ?? "‚Äî") : "‚Äî";
  
      const card = document.createElement("div");
      card.className = "compCard";
      card.innerHTML = `
        <div class="compHeader">
          <div>
            <div class="compTitle">${escapeHtml(c.name || "Untitled competition")}</div>
            <div class="compMeta">${escapeHtml(c.date || "‚Äî")} ‚Ä¢ ${escapeHtml((c.club||"").trim() || "No club")}</div>
          </div>
  
          <div class="profileActions">
            <button class="btn" data-edit="${c.id}" type="button">‚úèÔ∏è</button>
            <button class="btn danger" data-delcomp="${c.id}" type="button">Delete</button>
          </div>
        </div>
  
        <div class="compRow">
          <div class="compBadges">
            <span class="badge">
              <strong>${sum}</strong> / ${roundsCount * 25}
              <span style="font-weight:500; opacity:.85">
                &nbsp; ‚Ä¢ Final: ${escapeHtml(String(finalVal))}
                &nbsp; ‚Ä¢ Rounds: ${escapeHtml(roundsLine.replace(/ ‚Ä¢ /g, " ¬∑ "))}
              </span>
            </span>
          </div>
        </div>
  
        ${c.notes ? `<div class="small" style="margin-top:10px; white-space:pre-wrap">${escapeHtml(c.notes)}</div>` : ``}
      `;
  
      holder.appendChild(card);
    }
  
    // ‚úÖ wire edit/delete INSIDE the function (holder exists here)
    holder.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-edit");
        const comp = competitions.find(x => x.id === id);
        if(comp) openCompForm(comp);
      });
    });
  
    holder.querySelectorAll("[data-delcomp]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-delcomp");
        const comp = competitions.find(x => x.id === id);
        const ok = confirm(`Delete competition "${comp ? comp.name : ""}"?`);
        if(!ok) return;
  
        competitions = competitions.filter(x => x.id !== id);
        saveCompetitions(competitions);
        renderCompList();
        closeCompForm();
      });
    });
  }

  
  // --- Competition page controls ---
  
  $("newCompBtn").addEventListener("click", ()=>{
    openCompForm(null);
  });
  
  $("cancelCompBtn").addEventListener("click", closeCompForm);
  
  $("compRoundsCount").addEventListener("change", ()=>{
    const n = Math.max(1, Math.min(10, Math.floor(Number($("compRoundsCount").value || 5))));
    $("compRoundsCount").value = String(n);
    const rounds = ensureRoundsArray(n, readCompRoundsFromInputs());
    buildCompRoundInputs(rounds);
    updateCompTotalsLine();
  });
  
  $("compFinalPlayed").addEventListener("change", ()=>{
    const show = $("compFinalPlayed").value === "yes";
    $("finalScoreWrap").style.display = show ? "block" : "none";
    if(!show) $("compFinalScore").value = "";
  });
  
  $("saveCompBtn").addEventListener("click", ()=>{
    const name = ($("compName").value || "").trim();
    const date = ($("compDate").value || todayISO()).trim();
    const club = ($("compClub").value || "").trim();
    const roundsCount = Math.max(1, Math.min(10, Math.floor(Number($("compRoundsCount").value || 5))));
    const rounds = ensureRoundsArray(roundsCount, readCompRoundsFromInputs());
  
    const finalPlayed = $("compFinalPlayed").value === "yes";
    let finalScore = null;
    if(finalPlayed){
      const raw = ($("compFinalScore").value || "").trim();
      if(raw !== ""){
        let n = Math.floor(Number(raw));
        if(!Number.isFinite(n)) n = 0;
        finalScore = Math.max(0, n);
      } else {
        // if final is played, allow blank, but keep null
        finalScore = null;
      }
    }
  
    const notes = ($("compNotes").value || "").trim();
  
    if(!name){
      alert("Please enter a competition name.");
      $("compName").focus();
      return;
    }
  
    competitions = loadCompetitions();
  
    const now = Date.now();
    if(editingCompId){
      const idx = competitions.findIndex(x => x.id === editingCompId);
      if(idx >= 0){
        competitions[idx] = {
          ...competitions[idx],
          name, date, club,
          roundsCount,
          rounds,
          finalPlayed,
          ...(finalPlayed ? { finalScore } : { finalScore: null }),
          notes,
          updatedAt: now
        };
      }
    }else{
      competitions.unshift({
        id: uid(),
        name, date, club,
        roundsCount,
        rounds,
        finalPlayed,
        finalScore: finalPlayed ? finalScore : null,
        notes,
        createdAt: now,
        updatedAt: now
      });
    }
  
    saveCompetitions(competitions);
    closeCompForm();
    renderCompList();
  });
  



  function renderAll(){
    rebuildDropdowns();
    renderLive();
    renderOverview();
    renderCartridgesSection();
    renderSaved();
    micUI();
  }


  // Overview controls
  $("rangeSel").addEventListener("change", renderOverview);
  $("monthSel").addEventListener("change", renderOverview);
  $("clubSel").addEventListener("change", renderOverview);
  $("fieldSel").addEventListener("change", renderOverview);

  // Saved controls
  $("savedRange").addEventListener("change", renderSaved);
  $("savedDate").addEventListener("change", renderSaved);
  $("savedClub").addEventListener("change", renderSaved);
  $("savedField").addEventListener("change", renderSaved);

  // Tabs
  $("tabLiveBtn").addEventListener("click", ()=> setActiveTab("live"));
  $("tabOverviewBtn").addEventListener("click", ()=> setActiveTab("overview"));
  $("tabSavedBtn").addEventListener("click", ()=> setActiveTab("saved"));
  $("tabCompBtn").addEventListener("click", ()=> setActiveTab("comp"));


  function openProfileModal(){
    $("profileModal").classList.add("open");
    $("profileModal").setAttribute("aria-hidden", "false");
    renderProfilesUI();
  }
  function closeProfileModal(){
    $("profileModal").classList.remove("open");
    $("profileModal").setAttribute("aria-hidden", "true");
  }
  
  $("profileBtn").addEventListener("click", openProfileModal);
  $("closeProfileModal").addEventListener("click", closeProfileModal);
  $("profileModal").addEventListener("click", (e)=>{
    if(e.target === $("profileModal")) closeProfileModal();
  });
  
  function renderProfilesUI(){
    const profiles = loadProfiles();
    const activeId = getActiveProfileId();
  
    const list = $("profilesList");
    list.innerHTML = "";
  
    for(const p of profiles){
      const row = document.createElement("div");
      row.className = "profileRow";
  
      const left = document.createElement("div");
      left.innerHTML = `
        <div class="profileName">${escapeHtml(p.name)}</div>
        <div class="smallMuted">${p.id === activeId ? "Active" : "Tap Switch to use this profile"}</div>
      `;
  
      const actions = document.createElement("div");
      actions.className = "profileActions";
  
      const switchBtn = document.createElement("button");
      switchBtn.className = "btn primary";
      switchBtn.type = "button";
      switchBtn.textContent = (p.id === activeId) ? "Using" : "Switch";
      switchBtn.disabled = (p.id === activeId);
      switchBtn.addEventListener("click", ()=>{
        applyProfile(p.id);
        closeProfileModal();
      });
  
      const delBtn = document.createElement("button");
      delBtn.className = "btn danger";
      delBtn.type = "button";
      delBtn.textContent = "Delete";
      delBtn.disabled = (profiles.length === 1); // don‚Äôt allow deleting last profile
      delBtn.title = delBtn.disabled ? "You need at least one profile" : "Delete this profile";
      delBtn.addEventListener("click", ()=>{
        if(profiles.length === 1) return;
  
        const ok = confirm(`Delete profile "${p.name}"?\nThis removes its saved rounds & cartridge count.`);
        if(!ok) return;
  
        // Remove per-profile storage
        const key = makeKey(p.id);
        localStorage.removeItem(key);
        localStorage.removeItem(key + "_cartridge_manual");
  
        // Remove profile from list
        const updated = profiles.filter(x => x.id !== p.id);
        saveProfiles(updated);
  
        // If deleted active, switch to first remaining
        const activeNow = getActiveProfileId();
        if(activeNow === p.id){
          applyProfile(updated[0].id);
        } else {
          renderProfilesUI();
        }
      });
  
      const renameBtn = document.createElement("button");
      renameBtn.className = "btn";
      renameBtn.type = "button";
      renameBtn.innerHTML = "‚úèÔ∏è";
      renameBtn.title = "Rename profile";
      
      renameBtn.addEventListener("click", ()=>{
        const newName = prompt("Edit profile name:", p.name);
        if(newName === null) return; // cancelled
      
        const clean = newName.trim();
        if(!clean) return;
      
        // prevent duplicate names
        const exists = profiles.some(x =>
          x.id !== p.id &&
          (x.name || "").trim().toLowerCase() === clean.toLowerCase()
        );
        if(exists){
          alert("A profile with this name already exists.");
          return;
        }
      
        p.name = clean;
        saveProfiles(profiles);
      
        // update header instantly if active
        if(p.id === activeId){
          $("activeProfileLine").textContent = `Profile: ${p.name}`;
          activeProfile = p;
        }
      
        renderProfilesUI();
      });

      
      actions.appendChild(switchBtn);
      actions.appendChild(renameBtn);
      actions.appendChild(delBtn);
      
      row.appendChild(left);
      row.appendChild(actions);
      list.appendChild(row);

    }
  }
  
  $("addProfileBtn").addEventListener("click", ()=>{
    const name = ($("newProfileName").value || "").trim();
    if(!name){
      $("newProfileName").focus();
      return;
    }
  
    const profiles = loadProfiles();
    const newId = uid();
  
    profiles.unshift({ id: newId, name });
    saveProfiles(profiles);
  
    $("newProfileName").value = "";
  
    // switch immediately
    applyProfile(newId);
    renderProfilesUI();
  });

  // ===== Export/Import Profiles as JSON file (unlimited size) + Merge option =====

  function downloadTextFile(filename, text){
    const blob = new Blob([text], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  
  function safeParseJSON(text){
    try { return JSON.parse(text); } catch { return null; }
  }
  
  function cartKeyFor(pid){
    return makeKey(pid) + "_cartridge_manual";
  }
  
  function dedupeRoundsById(list){
    const seen = new Set();
    const out = [];
    for(const r of list){
      const id = r && r.id ? String(r.id) : null;
      if(id){
        if(seen.has(id)) continue;
        seen.add(id);
      }
      out.push(r);
    }
    return out;
  }
  
  function normalizeName(s){
    return String(s || "").trim().toLowerCase();
  }
  
  function buildProfilesExportPayload(mode){
    const profs = loadProfiles();
    const activeId = getActiveProfileId();
    const exportProfiles = (mode === "all")
      ? profs
      : profs.filter(p => p.id === activeId);
  
    return {
      v: 1,
      exportedAt: Date.now(),
      app: "Trap Tracker",
      profiles: exportProfiles.map(p => {
        const pid = p.id;
        const roundsRaw = localStorage.getItem(makeKey(pid));
        const cartRaw   = localStorage.getItem(cartKeyFor(pid));
        return {
          id: pid,
          name: p.name,
          rounds: roundsRaw ? (safeParseJSON(roundsRaw) || []) : [],
          cartManual: cartRaw ? Number(cartRaw) : 0
        };
      })
    };
  }
  
  // returns "merge" | "copy" | "skip"
  function askImportAction(profileName){
    const msg =
  `Profile "${profileName}" already exists.
  
  Type:
    m  = merge into existing
    c  = create a copy
    s  = skip this one`;
  
    const ans = (prompt(msg, "m") || "").trim().toLowerCase();
    if(ans === "m" || ans === "merge") return "merge";
    if(ans === "c" || ans === "copy")  return "copy";
    if(ans === "s" || ans === "skip")  return "skip";
    // default if user cancels/invalid:
    return "merge";
  }
  
  function importProfilesPayload(payload){
    if(!payload || payload.v !== 1 || !Array.isArray(payload.profiles)){
      alert("Invalid JSON file (missing profiles).");
      return;
    }
  
    const profs = loadProfiles();
    const byId = new Map(profs.map(p => [p.id, p]));
    const byName = new Map(profs.map(p => [normalizeName(p.name), p]));
  
    let importedCount = 0;
    let mergedCount = 0;
    let skippedCount = 0;
    let lastTouchedId = null;
  
    for(const inc of payload.profiles){
      if(!inc || !inc.name) continue;
  
      const incomingName = String(inc.name).trim() || "Imported";
      const incomingNameKey = normalizeName(incomingName);
  
      const incomingRounds = Array.isArray(inc.rounds) ? inc.rounds : [];
      const incomingCart = Number(inc.cartManual || 0);
      const incomingCartSafe = Number.isFinite(incomingCart) ? Math.max(0, Math.floor(incomingCart)) : 0;
  
      // If same name exists -> ask merge/copy/skip
      const existingByName = byName.get(incomingNameKey);
  
      if(existingByName){
        const action = askImportAction(incomingName);
        if(action === "skip"){
          skippedCount++;
          continue;
        }
  
        if(action === "merge"){
          const targetId = existingByName.id;
  
          // merge rounds
          const existingRoundsRaw = localStorage.getItem(makeKey(targetId));
          const existingRounds = existingRoundsRaw ? (safeParseJSON(existingRoundsRaw) || []) : [];
  
          const merged = dedupeRoundsById([ ...incomingRounds, ...existingRounds ]);
          localStorage.setItem(makeKey(targetId), JSON.stringify(merged));
  
          // merge cartridges (add)
          const existingCartRaw = localStorage.getItem(cartKeyFor(targetId));
          const existingCart = existingCartRaw ? Number(existingCartRaw) : 0;
          const existingCartSafe = Number.isFinite(existingCart) ? Math.max(0, Math.floor(existingCart)) : 0;
  
          localStorage.setItem(cartKeyFor(targetId), String(existingCartSafe + incomingCartSafe));
  
          mergedCount++;
          lastTouchedId = targetId;
          continue;
        }
  
        // else "copy" falls through to create a new profile
      }
  
      // Create new profile (copy or no conflict)
      let newId = (inc.id && !byId.has(inc.id)) ? inc.id : uid();
      while(byId.has(newId)) newId = uid();
  
      const newProfile = { id: newId, name: incomingName };
      profs.unshift(newProfile);
      byId.set(newId, newProfile);
  
      // keep name map updated (for later imports in same file)
      if(!byName.has(incomingNameKey)) byName.set(incomingNameKey, newProfile);
  
      localStorage.setItem(makeKey(newId), JSON.stringify(incomingRounds));
      localStorage.setItem(cartKeyFor(newId), String(incomingCartSafe));
  
      importedCount++;
      lastTouchedId = newId;
    }
  
    if(importedCount === 0 && mergedCount === 0){
      alert("No usable profiles found in this file.");
      return;
    }
  
    saveProfiles(profs);
  
    // Switch to the last touched profile
    if(lastTouchedId){
      applyProfile(lastTouchedId);
    } else {
      applyProfile(getActiveProfileId());
    }
  
    renderProfilesUI();
    renderAll();
  
    alert(`Done ‚úÖ\nImported: ${importedCount}\nMerged: ${mergedCount}\nSkipped: ${skippedCount}`);
  }
  
  // Export JSON
  $("exportProfileJsonBtn").addEventListener("click", ()=>{
    const mode = confirm("Export ALL profiles?\n\nOK = All profiles\nCancel = Only active profile")
      ? "all"
      : "active";
  
    const payload = buildProfilesExportPayload(mode);
    const ymd = new Date().toISOString().slice(0,10);
  
    const active = loadProfiles().find(p => p.id === getActiveProfileId());
    const activeName = active ? active.name : "active";
  
    const filename = mode === "all"
      ? `trap-tracker-profiles-${ymd}.json`
      : `trap-tracker-profile-${String(activeName).replace(/\s+/g,"-").toLowerCase()}-${ymd}.json`;
  
    downloadTextFile(filename, JSON.stringify(payload, null, 2));
  });
  
  // Import JSON
  $("importProfileJsonBtn").addEventListener("click", ()=>{
    $("importProfileFile").value = "";
    $("importProfileFile").click();
  });
  
  $("importProfileFile").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
  
    try{
      const text = await file.text();
      const payload = safeParseJSON(text);
      if(!payload){
        alert("That file is not valid JSON.");
        return;
      }
      importProfilesPayload(payload);
    }catch{
      alert("Could not read that file.");
    }
  });

  function hideLoader(){
    const el = document.getElementById("appLoader");
    if(!el) return;
    el.classList.add("hide");
    setTimeout(()=> el.remove(), 300);
  }



  // First render with active profile
  const initialProfileId = getActiveProfileId();
  applyProfile(initialProfileId);

</script>
</body>
</html>
